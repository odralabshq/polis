FROM rust:1-bookworm AS builder
WORKDIR /build
COPY crates/ crates/
COPY Cargo.toml Cargo.lock ./
RUN cargo build --release -p polis-mcp-agent

FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl && rm -rf /var/lib/apt/lists/*
RUN useradd -r -s /bin/false polis
COPY --from=builder /build/target/release/polis-mcp-agent /usr/bin/

# Create directory for Valkey TLS certificates (mounted at runtime).
# The polis user needs read access; the actual cert files are mounted :ro.
RUN mkdir -p /etc/valkey/tls && chown polis:polis /etc/valkey/tls

# No entrypoint script needed â€” the mTLS code loads the CA cert directly
# from the PEM file (/etc/valkey/tls/ca.crt) via TlsCertificates::root_cert,
# so the system trust store does NOT need to be updated at runtime.
# This avoids the su/setuid problem with no-new-privileges:true.
USER polis

ENV RUST_LOG=info
ENV polis_AGENT_LISTEN_ADDR=0.0.0.0:8080
ENV polis_AGENT_VALKEY_URL=redis://valkey:6379
EXPOSE 8080
CMD ["/usr/bin/polis-mcp-agent"]
