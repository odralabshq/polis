# Release Workflow for Polis
# Builds Docker images, bakes them into VM, builds CLI, creates release.
#
# Flow: Docker build → Export → Packer VM → CLI binary → GitHub Release
#
# Usage: Push a v* tag or manually trigger via Actions UI

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., v0.3.0)'
        required: true
        type: string
      push_docker:
        description: 'Push Docker images to GHCR (for developers)'
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/polis
  SYSBOX_VERSION: "0.6.7"
  SYSBOX_SHA256_AMD64: "b7ac389e5a19592cadf16e0ca30e40919516128f6e1b7f99e1cb4ff64554172e"

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write

jobs:
  # =========================================================
  # Validate version format
  # =========================================================
  validate:
    name: Validate Version
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.validate.outputs.version }}
      tag_name: ${{ steps.validate.outputs.tag_name }}
      is_prerelease: ${{ steps.validate.outputs.is_prerelease }}
      push_docker: ${{ steps.validate.outputs.push_docker }}
    steps:
      - name: Validate version format
        id: validate
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
            PUSH_DOCKER="${{ inputs.push_docker }}"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            PUSH_DOCKER="true"  # Always push on tag
          else
            echo "::error::Could not determine version"
            exit 1
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "::error::Invalid version format '$VERSION'. Expected: v0.0.0 or v0.0.0-suffix (e.g., v0.3.0-preview-1)"
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=${VERSION#v}" >> "$GITHUB_OUTPUT"
          echo "push_docker=$PUSH_DOCKER" >> "$GITHUB_OUTPUT"
          if [[ "$VERSION" == *"-"* ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi
          echo "✓ Version $VERSION validated (push_docker=$PUSH_DOCKER)"

  # =========================================================
  # Build Docker images and export tarball
  # =========================================================
  docker:
    name: Build Docker Images
    needs: validate
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive

      - name: Generate CA certificate for build
        run: |
          mkdir -p certs/ca
          openssl genrsa -out certs/ca/ca.key 4096
          openssl req -new -x509 -days 3650 -key certs/ca/ca.key -out certs/ca/ca.pem \
            -subj "/C=US/ST=Local/L=Local/O=Polis/OU=Gateway/CN=Polis CA"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to dhi.io
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: dhi.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GitHub Container Registry
        if: needs.validate.outputs.push_docker == 'true'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag images with release version
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          for img in $(docker images --format '{{.Repository}}:{{.Tag}}' | grep 'polis-.*-oss:latest'); do
            base=$(echo "$img" | sed 's/:latest$//')
            ghcr_img="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${base#polis-}"
            docker tag "$img" "${ghcr_img}:${VERSION}"
            docker tag "$img" "${ghcr_img}:latest"
          done

      - name: Build all images
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          for svc in RESOLVER CERTGEN GATE SENTINEL SCANNER WORKSPACE HOST_INIT STATE TOOLBOX; do
            export "POLIS_${svc}_VERSION=${VERSION}"
          done
          docker compose build

      - name: Push images to GHCR (optional)
        if: needs.validate.outputs.push_docker == 'true'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          for ghcr_img in $(docker images --format '{{.Repository}}:{{.Tag}}' | grep "polis-.*-oss:${VERSION}"); do
            base="${ghcr_img%:${VERSION}}"
            docker push "${ghcr_img}"
            docker push "${base}:latest"
            echo "✓ Pushed ${ghcr_img}"
          done

      - name: Export images tarball
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          # Get all polis images
          POLIS_IMAGES=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep "polis-.*-oss:${VERSION}" | tr '\n' ' ')
          # Get external images from compose - parse raw YAML to avoid docker compose config secrets requirement
          EXTERNAL_IMAGES=$(grep -oP '^\s+image:\s+\K\S+' docker-compose.yml | grep -v 'ghcr.io/odralabshq' | grep -v 'go-httpbin' | sed 's/@sha256:[a-f0-9]*//' | sort -u | tr '\n' ' ')
          # Pull and tag external images
          for img in $EXTERNAL_IMAGES; do
            docker pull "$img"
          done
          mkdir -p .build
          docker save -o .build/polis-images.tar $POLIS_IMAGES $EXTERNAL_IMAGES
          echo "✓ Exported: $POLIS_IMAGES $EXTERNAL_IMAGES"

      - name: Upload images tarball
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: docker-images
          path: .build/polis-images.tar
          retention-days: 1

  # =========================================================
  # Build VM image with Docker images baked in
  # =========================================================
  vm:
    name: Build VM Image
    needs: [validate, docker]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download images tarball
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          name: docker-images
          path: .build

      - name: Install QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils xorriso

      - name: Enable KVM group permissions
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Packer
        uses: hashicorp/setup-packer@1aa358be5cf73883762b302a3a03abd66e75b232 # v3.1.0

      - name: Init Packer
        env:
          PACKER_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: packer init packer/

      - name: Generate Polis config bundle
        run: |
          export POLIS_IMAGE_VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p .build
          bash packer/scripts/bundle-polis-config.sh

      - name: Build VM image
        run: |
          cd packer
          packer build \
            -var "polis_version=${{ needs.validate.outputs.version }}" \
            -var "images_tar=${PWD}/../.build/polis-images.tar" \
            -var "config_tar=${PWD}/../.build/polis-config.tar.gz" \
            -var "sysbox_version=${SYSBOX_VERSION}" \
            -var "sysbox_sha256_amd64=${SYSBOX_SHA256_AMD64}" \
            -var "arch=amd64" \
            polis-vm.pkr.hcl

      - name: Sign VM image checksum
        env:
          POLIS_SIGNING_KEY: ${{ secrets.POLIS_SIGNING_KEY }}
        run: |
          cargo install zipsign --version 0.2.1 --locked
          echo "${POLIS_SIGNING_KEY}" | base64 -d > /tmp/polis-release.key
          VERSION="${{ needs.validate.outputs.version }}"
          IMAGE="polis-${VERSION}-amd64.qcow2"
          cd packer/output
          sha256sum "${IMAGE}" > checksum.txt
          tmpdir=$(mktemp -d)
          tar -czf "${tmpdir}/sidecar.tar.gz" -C . checksum.txt
          zipsign sign tar --context "" "${tmpdir}/sidecar.tar.gz" /tmp/polis-release.key \
            -o "${IMAGE}.sha256" -f
          rm -rf "${tmpdir}" /tmp/polis-release.key checksum.txt
          echo "✓ ${IMAGE}.sha256 (signed)"

      - name: Attest VM provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: packer/output/*.qcow2

      - name: Upload VM artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: vm-image
          path: |
            packer/output/*.qcow2
            packer/output/*.qcow2.sha256
          retention-days: 1

  # =========================================================
  # Build CLI binary (Linux only)
  # =========================================================
  cli:
    name: Build CLI (${{ matrix.artifact }})
    needs: validate
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            artifact: polis-linux-amd64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Build CLI
        run: |
          cd cli
          cargo build --release --target ${{ matrix.target }}

      - name: Copy binary
        run: cp cli/target/${{ matrix.target }}/release/polis ${{ matrix.artifact }}

      - name: Generate checksum
        run: sha256sum ${{ matrix.artifact }} > ${{ matrix.artifact }}.sha256

      - name: Create tarball
        run: tar -czf ${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }}

      - name: Sign CLI tarball
        env:
          POLIS_SIGNING_KEY: ${{ secrets.POLIS_SIGNING_KEY }}
        run: |
          cargo install zipsign --version 0.2.1 --locked
          echo "${POLIS_SIGNING_KEY}" | base64 -d > /tmp/polis-release.key
          zipsign sign tar --context "" "${{ matrix.artifact }}.tar.gz" /tmp/polis-release.key \
            -o "${{ matrix.artifact }}.tar.gz.signed" -f
          mv "${{ matrix.artifact }}.tar.gz.signed" "${{ matrix.artifact }}.tar.gz"
          rm -f /tmp/polis-release.key
          echo "✓ Signed: ${{ matrix.artifact }}.tar.gz"
        shell: bash

      - name: Attest CLI provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: ${{ matrix.artifact }}

      - name: Upload CLI artifact
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7.0.0
        with:
          name: cli-${{ matrix.target }}
          path: |
            ${{ matrix.artifact }}
            ${{ matrix.artifact }}.sha256
            ${{ matrix.artifact }}.tar.gz
          retention-days: 1

  # =========================================================
  # Upload VM image to S3 / CloudFront CDN
  # =========================================================
  cdn:
    name: Upload to CDN
    needs: [validate, vm]
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
    steps:
      - name: Download VM artifact
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          name: vm-image
          path: ./vm

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6.0.0
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Upload VM image to S3
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          QCOW2=$(ls vm/*.qcow2 | head -1)
          FILENAME=$(basename "${QCOW2}")
          aws s3 cp "${QCOW2}" \
            "s3://polis-releases/${VERSION}/${FILENAME}" \
            --no-progress
          echo "✓ Uploaded to s3://polis-releases/${VERSION}/${FILENAME}"

      - name: Invalidate CloudFront cache
        env:
          CLOUDFRONT_DIST_ID: ${{ secrets.CLOUDFRONT_DIST_ID }}
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          aws cloudfront create-invalidation \
            --distribution-id "${CLOUDFRONT_DIST_ID}" \
            --paths "/${VERSION}/*"
          echo "✓ CloudFront cache invalidated for /${VERSION}/*"

  # =========================================================
  # Create GitHub Release
  # =========================================================
  release:
    name: Create Release
    needs: [validate, vm, cli, cdn]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Create and push tag (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG="${{ needs.validate.outputs.tag_name }}"
          if git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
            echo "Tag $TAG already exists on remote, skipping"
          else
            git tag -a "$TAG" -m "Release ${{ needs.validate.outputs.version }}"
            git push origin "$TAG" || echo "::warning::Tag push blocked by repository rules — release action will create the tag"
          fi

      - name: Download VM artifact
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          name: vm-image
          path: ./vm

      - name: Download CLI artifacts
        uses: actions/download-artifact@70fc10c6e5e1ce46ad2ea6f2b72d43f7d47b13c3 # v8.0.0
        with:
          pattern: cli-*
          path: ./cli-bin
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          name: Polis ${{ needs.validate.outputs.version }}
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          files: |
            vm/*.qcow2
            vm/*.qcow2.sha256
            cli-bin/polis-linux-amd64.sha256
            cli-bin/polis-linux-amd64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
