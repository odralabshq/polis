# Release Workflow for Polis
# Builds Docker images, signs them with cosign, builds CLI, creates release.
#
# Flow: validate → docker (build+push+sign+SBOM+digest) → prepare (assets) → cli → release
#
# Usage: Push a v* tag or manually trigger via Actions UI

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., v0.3.0)'
        required: true
        type: string
      push_docker:
        description: 'Push Docker images to GHCR (for developers)'
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/polis
  SYSBOX_VERSION: "0.6.7"
  SYSBOX_SHA256_AMD64: "b7ac389e5a19592cadf16e0ca30e40919516128f6e1b7f99e1cb4ff64554172e"

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write

jobs:
  # =========================================================
  # Validate version format
  # =========================================================
  validate:
    name: Validate Version
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.validate.outputs.version }}
      tag_name: ${{ steps.validate.outputs.tag_name }}
      is_prerelease: ${{ steps.validate.outputs.is_prerelease }}
      push_docker: ${{ steps.validate.outputs.push_docker }}
    steps:
      - name: Validate version format
        id: validate
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
            PUSH_DOCKER="${{ inputs.push_docker }}"
          elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            PUSH_DOCKER="true"  # Always push on tag
          else
            echo "::error::Could not determine version"
            exit 1
          fi

          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "::error::Invalid version format '$VERSION'. Expected: v0.0.0 or v0.0.0-suffix (e.g., v0.3.0-preview-1)"
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=${VERSION#v}" >> "$GITHUB_OUTPUT"
          echo "push_docker=$PUSH_DOCKER" >> "$GITHUB_OUTPUT"
          if [[ "$VERSION" == *"-"* ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi
          echo "✓ Version $VERSION validated (push_docker=$PUSH_DOCKER)"

  # =========================================================
  # Build Docker images, push to GHCR, sign with cosign,
  # generate digest manifest, and produce SBOMs
  # =========================================================
  docker:
    name: Build Docker Images
    needs: validate
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive

      - name: Generate CA certificate for build
        run: |
          mkdir -p certs/ca
          openssl genrsa -out certs/ca/ca.key 4096
          openssl req -new -x509 -days 3650 -key certs/ca/ca.key -out certs/ca/ca.pem \
            -subj "/C=US/ST=Local/L=Local/O=Polis/OU=Gateway/CN=Polis CA"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to dhi.io
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: dhi.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GitHub Container Registry
        if: needs.validate.outputs.push_docker == 'true'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build all images
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          for svc in RESOLVER CERTGEN GATE SENTINEL SCANNER WORKSPACE HOST_INIT STATE TOOLBOX; do
            export "POLIS_${svc}_VERSION=${VERSION}"
          done
          docker compose build

      - name: Tag images with release version
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          for img in $(docker images --format '{{.Repository}}:{{.Tag}}' | grep 'polis-.*-oss:latest'); do
            base=$(echo "$img" | sed 's/:latest$//')
            ghcr_img="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${base#polis-}"
            docker tag "$img" "${ghcr_img}:${VERSION}"
            docker tag "$img" "${ghcr_img}:latest"
          done

      - name: Push images to GHCR
        if: needs.validate.outputs.push_docker == 'true'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          for ghcr_img in $(docker images --format '{{.Repository}}:{{.Tag}}' | grep "polis-.*-oss:${VERSION}"); do
            base="${ghcr_img%:${VERSION}}"
            docker push "${ghcr_img}"
            docker push "${base}:latest"
            echo "✓ Pushed ${ghcr_img}"
          done

      - name: Install cosign
        if: needs.validate.outputs.push_docker == 'true'
        uses: sigstore/cosign-installer@v3

      - name: Sign images and generate digest manifest
        if: needs.validate.outputs.push_docker == 'true'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p .build
          DIGEST_MANIFEST=".build/image-digests.json"
          echo "{}" > "${DIGEST_MANIFEST}"

          for img in $(docker images --format '{{.Repository}}:{{.Tag}}' | grep "polis-.*-oss:${VERSION}"); do
            # Get the digest for the pushed image
            DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${img}" | cut -d@ -f2)
            if [[ -z "${DIGEST}" ]]; then
              echo "::warning::No RepoDigest found for ${img} — skipping signing"
              continue
            fi

            # Sign by digest using keyless GitHub OIDC
            IMAGE_REF="${img%:${VERSION}}@${DIGEST}"
            cosign sign --yes "${IMAGE_REF}"
            echo "✓ Signed ${IMAGE_REF}"

            # Add to digest manifest: map versioned image ref → sha256 digest
            jq --arg img "${img}" --arg digest "${DIGEST}" \
              '. + {($img): $digest}' "${DIGEST_MANIFEST}" \
              > tmp.json && mv tmp.json "${DIGEST_MANIFEST}"
          done

          echo "✓ Digest manifest:"
          cat "${DIGEST_MANIFEST}"

      - name: Upload digest manifest artifact
        if: needs.validate.outputs.push_docker == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: image-digests
          path: .build/image-digests.json
          retention-days: 1

      - name: Generate SBOM for resolver image
        if: needs.validate.outputs.push_docker == 'true'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-resolver-oss:${{ needs.validate.outputs.version }}
          artifact-name: sbom-resolver.spdx.json
          output-file: .build/sbom-resolver.spdx.json

      - name: Generate SBOM for certgen image
        if: needs.validate.outputs.push_docker == 'true'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-certgen-oss:${{ needs.validate.outputs.version }}
          artifact-name: sbom-certgen.spdx.json
          output-file: .build/sbom-certgen.spdx.json

      - name: Generate SBOM for gate image
        if: needs.validate.outputs.push_docker == 'true'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-gate-oss:${{ needs.validate.outputs.version }}
          artifact-name: sbom-gate.spdx.json
          output-file: .build/sbom-gate.spdx.json

      - name: Generate SBOM for sentinel image
        if: needs.validate.outputs.push_docker == 'true'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-sentinel-oss:${{ needs.validate.outputs.version }}
          artifact-name: sbom-sentinel.spdx.json
          output-file: .build/sbom-sentinel.spdx.json

      - name: Generate SBOM for scanner image
        if: needs.validate.outputs.push_docker == 'true'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-scanner-oss:${{ needs.validate.outputs.version }}
          artifact-name: sbom-scanner.spdx.json
          output-file: .build/sbom-scanner.spdx.json

      - name: Generate SBOM for workspace image
        if: needs.validate.outputs.push_docker == 'true'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-workspace-oss:${{ needs.validate.outputs.version }}
          artifact-name: sbom-workspace.spdx.json
          output-file: .build/sbom-workspace.spdx.json

      - name: Generate SBOM for init image
        if: needs.validate.outputs.push_docker == 'true'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-init-oss:${{ needs.validate.outputs.version }}
          artifact-name: sbom-init.spdx.json
          output-file: .build/sbom-init.spdx.json

      - name: Generate SBOM for state image
        if: needs.validate.outputs.push_docker == 'true'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-state-oss:${{ needs.validate.outputs.version }}
          artifact-name: sbom-state.spdx.json
          output-file: .build/sbom-state.spdx.json

      - name: Generate SBOM for toolbox image
        if: needs.validate.outputs.push_docker == 'true'
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-toolbox-oss:${{ needs.validate.outputs.version }}
          artifact-name: sbom-toolbox.spdx.json
          output-file: .build/sbom-toolbox.spdx.json

      - name: Upload SBOMs artifact
        if: needs.validate.outputs.push_docker == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sboms
          path: .build/sbom-*.spdx.json
          retention-days: 1

  # =========================================================
  # Prepare embedded assets for CLI compilation:
  #   - Run generate-agent.sh per agent
  #   - Build polis-setup.config.tar
  #   - Copy cloud-init.yaml
  #   - Download image-digests.json from docker job
  # =========================================================
  prepare:
    name: Prepare Embedded Assets
    needs: [validate, docker]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download image-digests artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: image-digests
          path: .build/

      - name: Generate agent artifacts
        run: |
          # generate-agent.sh requires yq — only needed at CI time, not in VM
          for agent_dir in agents/*/; do
            agent_name=$(basename "$agent_dir")
            [[ "$agent_name" == "_template" ]] && continue
            echo "Generating artifacts for agent: $agent_name"
            ./scripts/generate-agent.sh "$agent_name" agents
          done

      - name: Build polis-setup.config.tar
        run: |
          mkdir -p .build/assets
          tar cf .build/assets/polis-setup.config.tar \
            docker-compose.yml \
            scripts/ \
            agents/
          echo "✓ Built polis-setup.config.tar"

      - name: Copy cloud-init.yaml to assets
        run: |
          cp cloud-init.yaml .build/assets/cloud-init.yaml
          echo "✓ Copied cloud-init.yaml"

      - name: Copy image-digests.json to assets
        run: |
          cp .build/image-digests.json .build/assets/image-digests.json
          echo "✓ Copied image-digests.json"

      - name: Upload prepared assets artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: prepared-assets
          path: .build/assets/
          retention-days: 1

  # =========================================================
  # Build CLI binary for all 3 targets
  # Embeds cloud-init.yaml, image-digests.json, polis-setup.config.tar
  # via include_dir!("$CARGO_MANIFEST_DIR/../.build/assets")
  # =========================================================
  cli:
    name: Build CLI (${{ matrix.artifact }})
    needs: [validate, docker, prepare]
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            artifact: polis-linux-amd64
            binary: polis
          - os: windows-2022
            target: x86_64-pc-windows-gnu
            artifact: polis-windows-amd64
            binary: polis.exe
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: polis-macos-aarch64
            binary: polis
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Download prepared assets
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: prepared-assets
          path: .build/assets/

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Build CLI
        run: cargo build --release --target ${{ matrix.target }}
        working-directory: cli

      - name: Copy binary (Unix)
        if: runner.os != 'Windows'
        run: cp cli/target/${{ matrix.target }}/release/${{ matrix.binary }} ${{ matrix.artifact }}

      - name: Copy binary (Windows)
        if: runner.os == 'Windows'
        run: cp cli/target/${{ matrix.target }}/release/${{ matrix.binary }} ${{ matrix.artifact }}.exe
        shell: pwsh

      - name: Generate checksum (Unix)
        if: runner.os != 'Windows'
        run: sha256sum ${{ matrix.artifact }} > ${{ matrix.artifact }}.sha256

      - name: Generate checksum (Windows)
        if: runner.os == 'Windows'
        run: |
          $hash = (Get-FileHash "${{ matrix.artifact }}.exe" -Algorithm SHA256).Hash.ToLower()
          "$hash  ${{ matrix.artifact }}.exe" | Out-File -Encoding ascii "${{ matrix.artifact }}.sha256"
        shell: pwsh

      - name: Create tarball (Unix)
        if: runner.os != 'Windows'
        run: tar -czf ${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }}

      - name: Create zip (Windows)
        if: runner.os == 'Windows'
        run: Compress-Archive -Path "${{ matrix.artifact }}.exe" -DestinationPath "${{ matrix.artifact }}.zip"
        shell: pwsh

      - name: Sign CLI tarball (Unix)
        if: runner.os != 'Windows'
        env:
          POLIS_SIGNING_KEY: ${{ secrets.POLIS_SIGNING_KEY }}
        run: |
          cargo install zipsign --version 0.2.1 --locked
          echo "${POLIS_SIGNING_KEY}" | base64 -d > /tmp/polis-release.key
          zipsign sign tar --context "" "${{ matrix.artifact }}.tar.gz" /tmp/polis-release.key \
            -o "${{ matrix.artifact }}.tar.gz.signed" -f
          mv "${{ matrix.artifact }}.tar.gz.signed" "${{ matrix.artifact }}.tar.gz"
          rm -f /tmp/polis-release.key
          echo "✓ Signed: ${{ matrix.artifact }}.tar.gz"
        shell: bash

      - name: Sign CLI zip (Windows)
        if: runner.os == 'Windows'
        env:
          POLIS_SIGNING_KEY: ${{ secrets.POLIS_SIGNING_KEY }}
        run: |
          cargo install zipsign --version 0.2.1 --locked
          $keyFile = [System.IO.Path]::GetTempFileName()
          [System.Convert]::FromBase64String($env:POLIS_SIGNING_KEY) | Set-Content -Path $keyFile -Encoding Byte
          zipsign sign file --context "" "${{ matrix.artifact }}.zip" $keyFile -o "${{ matrix.artifact }}.zip.signed" -f
          Move-Item "${{ matrix.artifact }}.zip.signed" "${{ matrix.artifact }}.zip" -Force
          Remove-Item $keyFile
          echo "✓ Signed: ${{ matrix.artifact }}.zip"
        shell: pwsh

      - name: Attest CLI provenance (Unix)
        if: runner.os != 'Windows'
        uses: actions/attest-build-provenance@62fc1d596301d0ab9914e1fec14dc5c8d93f65cd # v3.2.0
        with:
          subject-path: ${{ matrix.artifact }}

      - name: Attest CLI provenance (Windows)
        if: runner.os == 'Windows'
        uses: actions/attest-build-provenance@62fc1d596301d0ab9914e1fec14dc5c8d93f65cd # v3.2.0
        with:
          subject-path: ${{ matrix.artifact }}.exe

      - name: Upload CLI artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: cli-${{ matrix.target }}
          path: |
            ${{ matrix.artifact }}
            ${{ matrix.artifact }}.sha256
            ${{ matrix.artifact }}.tar.gz
          retention-days: 1

      - name: Upload CLI artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: cli-${{ matrix.target }}
          path: |
            ${{ matrix.artifact }}.exe
            ${{ matrix.artifact }}.sha256
            ${{ matrix.artifact }}.zip
          retention-days: 1

  # =========================================================
  # Create GitHub Release with CLI binaries, checksums,
  # digest manifest, and SBOMs
  # =========================================================
  release:
    name: Create Release
    needs: [validate, docker, cli]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Create and push tag (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          TAG="${{ needs.validate.outputs.tag_name }}"
          if git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
            echo "Tag $TAG already exists on remote, skipping"
          else
            git tag -a "$TAG" -m "Release ${{ needs.validate.outputs.version }}"
            git push origin "$TAG" || echo "::warning::Tag push blocked by repository rules — release action will create the tag"
          fi

      - name: Download CLI artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: cli-*
          path: ./cli-bin
          merge-multiple: true

      - name: Download image-digests artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: image-digests
          path: ./release-assets

      - name: Download SBOMs artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: sboms
          path: ./release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          name: Polis ${{ needs.validate.outputs.version }}
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          files: |
            cli-bin/polis-linux-amd64
            cli-bin/polis-linux-amd64.sha256
            cli-bin/polis-linux-amd64.tar.gz
            cli-bin/polis-windows-amd64.exe
            cli-bin/polis-windows-amd64.sha256
            cli-bin/polis-windows-amd64.zip
            cli-bin/polis-macos-aarch64
            cli-bin/polis-macos-aarch64.sha256
            cli-bin/polis-macos-aarch64.tar.gz
            release-assets/image-digests.json
            release-assets/sbom-*.spdx.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
