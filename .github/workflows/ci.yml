name: CI

permissions:
  contents: read
  security-events: write
  actions: read

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  SYSBOX_VERSION: "0.6.7"
  SYSBOX_SHA256: "b7ac389e5a19592cadf16e0ca30e40919516128f6e1b7f99e1cb4ff64554172e"
  POLIS_IMAGES: >-
    polis-resolver-oss:latest
    polis-gate-oss:latest
    polis-certgen-oss:latest
    polis-sentinel-oss:latest
    polis-scanner-oss:latest
    polis-workspace-oss:latest
    polis-toolbox-oss:latest

jobs:
  # ── Stage 1a: Lint Rust ───────────────────────────────────────────
  lint-rust:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive
          persist-credentials: false

      - uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7
        with:
          toolchain: stable
          components: rustfmt, clippy

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

  # ── Stage 1b: Lint C ──────────────────────────────────────────────
  lint-c:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck

      - name: cppcheck
        run: |
          find services/sentinel/modules -name '*.c' -print0 | \
            xargs -0 cppcheck --enable=warning,performance --error-exitcode=1

  # ── Stage 2a: Test Rust ───────────────────────────────────────────
  test-rust:
    needs: [lint-rust]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive
          persist-credentials: false

      - uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7
        with:
          toolchain: stable

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - run: cargo test --workspace

  # ── Stage 2b: Test C ──────────────────────────────────────────────
  test-c:
    needs: [lint-c]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Compile and run C tests
        run: |
          for src in tests/native/sentinel/test_*.c; do
            bin="${src%.c}"
            gcc -Wall -Werror -o "$bin" "$src"
            "$bin"
          done

  # ── Stage 3a: Build containers ────────────────────────────────────
  build-containers:
    runs-on: ubuntu-24.04
    needs: [test-rust, test-c]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.19.0@sha256:14aa1b4dd92ea0a4cd03a54d0c6079046ea98cd0c0ae6176bdd7036ba370cbbe
            network=host

      - name: Build images (compose + buildx GHA cache)
        run: |
          touch .env
          docker buildx bake \
            --set '*.cache-from=type=gha' \
            --set '*.cache-to=type=gha,mode=max' \
            --load \
            -f docker-compose.yml

      - name: Save and compress images
        run: |
          docker save ${{ env.POLIS_IMAGES }} | zstd -T0 -3 -o polis-images.tar.zst

      - name: Upload image artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v6.0.0
        with:
          name: polis-images
          path: polis-images.tar.zst
          retention-days: 1
          compression-level: 0

  # ── Stage 3b: BATS unit tests ─────────────────────────────────────
  unit-tests:
    runs-on: ubuntu-24.04
    needs: [test-rust, test-c]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive
          persist-credentials: false

      - name: Generate secrets for ACL structure tests
        run: |
          chmod +x ./services/state/scripts/generate-secrets.sh
          touch .env
          ./services/state/scripts/generate-secrets.sh ./secrets .

      - name: Run unit tests
        run: ./tests/run-tests.sh unit

  # ── Stage 3c: Scan images ─────────────────────────────────────────
  scan-images:
    runs-on: ubuntu-24.04
    needs: build-containers
    strategy:
      matrix:
        image:
          - polis-gate-oss
          - polis-sentinel-oss
          - polis-workspace-oss
          - polis-scanner-oss
          - polis-resolver-oss
          - polis-toolbox-oss
    steps:
      - name: Download image artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.2.0
        with:
          name: polis-images

      - name: Load images
        run: zstd -d polis-images.tar.zst --stdout | docker load

      - name: Scan ${{ matrix.image }} with Snyk
        uses: snyk/actions/docker@9adf32b1121593767fc3c057af55b55db032dc04
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ matrix.image }}:latest
          args: --severity-threshold=high
        continue-on-error: true

  # ── Stage 4: Integration tests ────────────────────────────────────
  integration-tests:
    runs-on: ubuntu-24.04
    needs: [build-containers, unit-tests]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install sysbox
        run: |
          docker rm -f $(docker ps -aq) 2>/dev/null || true
          wget -q "https://downloads.nestybox.com/sysbox/releases/v${SYSBOX_VERSION}/sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb"
          echo "${SYSBOX_SHA256}  sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb" | sha256sum -c -
          sudo apt-get install -y jq "./sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb"
          sudo mkdir -p /etc/docker
          echo '{"runtimes":{"sysbox-runc":{"path":"/usr/bin/sysbox-runc"}}}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Download image artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.2.0
        with:
          name: polis-images

      - name: Load images
        run: zstd -d polis-images.tar.zst --stdout | docker load

      - name: Setup certificates and secrets
        run: |
          chmod +x ./cli/polis.sh ./services/*/scripts/*.sh ./agents/openclaw/install.sh ./agents/openclaw/scripts/*.sh ./tools/*.sh ./scripts/*.sh ./tests/run-tests.sh
          ./cli/polis.sh setup-ca
          ./services/state/scripts/generate-certs.sh ./certs/valkey
          chmod 644 ./certs/valkey/*.crt
          chmod a+r ./certs/valkey/*.key
          touch .env
          ./services/state/scripts/generate-secrets.sh ./secrets .
          chmod 644 ./secrets/valkey_users.acl

      - name: Start containers
        run: ./cli/polis.sh up

      - name: Wait for healthy
        run: |
          for i in $(seq 1 60); do
            HEALTHY=$(docker ps --filter "health=healthy" --format "{{.Names}}" | sort)
            if echo "$HEALTHY" | grep -q "polis-gate" && \
               echo "$HEALTHY" | grep -q "polis-sentinel" && \
               echo "$HEALTHY" | grep -q "polis-state" && \
               echo "$HEALTHY" | grep -q "polis-toolbox" && \
               echo "$HEALTHY" | grep -q "polis-workspace"; then
              echo "All containers healthy"
              exit 0
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done
          echo "Timeout" && docker ps -a && exit 1

      - name: Run integration tests
        run: ./tests/run-tests.sh --ci integration

      - name: Show logs on failure
        if: failure()
        run: |
          for c in polis-gate polis-sentinel polis-scanner polis-state polis-toolbox polis-workspace; do
            echo "=== $c ===" && docker logs "$c" 2>&1 | tail -30 || true
          done
          docker ps -a

  # ── Stage 5: E2E tests ─────────────────────────────────────────────
  e2e-tests:
    runs-on: ubuntu-24.04
    needs: integration-tests
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install sysbox
        run: |
          docker rm -f $(docker ps -aq) 2>/dev/null || true
          wget -q "https://downloads.nestybox.com/sysbox/releases/v${SYSBOX_VERSION}/sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb"
          echo "${SYSBOX_SHA256}  sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb" | sha256sum -c -
          sudo apt-get install -y jq "./sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb"
          sudo mkdir -p /etc/docker
          echo '{"runtimes":{"sysbox-runc":{"path":"/usr/bin/sysbox-runc"}}}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Download image artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.2.0
        with:
          name: polis-images

      - name: Load images
        run: zstd -d polis-images.tar.zst --stdout | docker load

      - name: Setup certificates and secrets
        run: |
          chmod +x ./cli/polis.sh ./services/*/scripts/*.sh ./agents/openclaw/install.sh ./agents/openclaw/scripts/*.sh ./tools/*.sh ./scripts/*.sh ./tests/run-tests.sh
          ./cli/polis.sh setup-ca
          ./services/state/scripts/generate-certs.sh ./certs/valkey
          chmod 644 ./certs/valkey/*.crt
          chmod a+r ./certs/valkey/*.key
          touch .env
          ./services/state/scripts/generate-secrets.sh ./secrets .
          chmod 644 ./secrets/valkey_users.acl

      - name: Start containers
        run: |
          docker compose --profile test up -d httpbin 2>/dev/null || true
          ./cli/polis.sh up

      - name: Wait for healthy
        run: |
          for i in $(seq 1 60); do
            HEALTHY=$(docker ps --filter "health=healthy" --format "{{.Names}}" | sort)
            if echo "$HEALTHY" | grep -q "polis-gate" && \
               echo "$HEALTHY" | grep -q "polis-sentinel" && \
               echo "$HEALTHY" | grep -q "polis-state" && \
               echo "$HEALTHY" | grep -q "polis-toolbox" && \
               echo "$HEALTHY" | grep -q "polis-workspace"; then
              echo "All containers healthy"
              exit 0
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done
          echo "Timeout" && docker ps -a && exit 1

      - name: Run E2E tests
        run: ./tests/run-tests.sh --ci e2e

      - name: Show logs on failure
        if: failure()
        run: |
          for c in polis-gate polis-sentinel polis-scanner polis-state polis-toolbox polis-workspace; do
            echo "=== $c ===" && docker logs "$c" 2>&1 | tail -30 || true
          done
          docker ps -a

  # ── Security: CodeQL ──────────────────────────────────────────────
  security-codeql:
    runs-on: ubuntu-24.04
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: github/codeql-action/init@f5c2471be782132e47a6e6f9c725e56730d6e9a3 # v3.32.3
        with:
          languages: c-cpp

      - name: Build C modules for analysis
        run: |
          set -e
          sudo apt-get update && sudo apt-get install -y libicapapi-dev libhiredis-dev libssl-dev
          for f in services/sentinel/modules/*/*.c; do
            gcc -c -Wall "$f" -o /dev/null \
              -I/usr/include/c_icap \
              -I/usr/include/hiredis || true
          done

      - uses: github/codeql-action/analyze@f5c2471be782132e47a6e6f9c725e56730d6e9a3 # v3.32.3

  # ── Security: Snyk Code (SAST) ────────────────────────────────────
  security-snyk-code:
    runs-on: ubuntu-24.04
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: snyk/actions/setup@9adf32b1121593767fc3c057af55b55db032dc04

      - name: Snyk Code test (SAST)
        run: snyk code test --severity-threshold=high --sarif-file-output=snyk-code.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - uses: github/codeql-action/upload-sarif@f5c2471be782132e47a6e6f9c725e56730d6e9a3 # v3.32.3
        with:
          sarif_file: snyk-code.sarif
        if: always()

  # ── Security: Snyk IaC ────────────────────────────────────────────
  security-snyk-iac:
    runs-on: ubuntu-24.04
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - uses: snyk/actions/setup@9adf32b1121593767fc3c057af55b55db032dc04

      - name: Snyk IaC test
        run: snyk iac test --severity-threshold=high --sarif-file-output=snyk-iac.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        continue-on-error: true

      - uses: github/codeql-action/upload-sarif@f5c2471be782132e47a6e6f9c725e56730d6e9a3 # v3.32.3
        with:
          sarif_file: snyk-iac.sarif
        if: always()

  # ── Security: SonarCloud ──────────────────────────────────────────
  security-sonarcloud:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
