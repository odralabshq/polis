name: Test Suite

permissions:
  contents: read

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  SYSBOX_VERSION: "0.6.7"

jobs:
  unit-tests:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Run unit tests
        run: ./tests/run-tests.sh unit

  integration-tests:
    runs-on: ubuntu-24.04
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Install sysbox
        run: |
          wget -q "https://downloads.nestybox.com/sysbox/releases/v${SYSBOX_VERSION}/sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb"
          sudo apt-get install -y jq "./sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb"
          sudo mkdir -p /etc/docker
          echo '{"runtimes":{"sysbox-runc":{"path":"/usr/bin/sysbox-runc"}}}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Setup certificates and secrets
        run: |
          chmod +x ./cli/polis.sh ./services/*/scripts/*.sh ./agents/openclaw/install.sh ./agents/openclaw/scripts/*.sh ./tools/*.sh ./scripts/*.sh ./tests/run-tests.sh
          ./cli/polis.sh setup-ca
          ./services/state/scripts/generate-certs.sh ./certs/valkey
          # Certs need 644 for cross-UID bind-mount access
          chmod 644 ./certs/valkey/*.crt
          # Keys: add read for container UIDs (bind-mount); CI-only — production should use per-service secrets
          chmod a+r ./certs/valkey/*.key
          touch .env
          ./services/state/scripts/generate-secrets.sh ./secrets .
          chmod 644 ./secrets/valkey_users.acl

      - name: Build and start containers
        run: |
          ./cli/polis.sh build
          ./cli/polis.sh up

      - name: Wait for healthy
        run: |
          for i in $(seq 1 60); do
            HEALTHY=$(docker ps --filter "health=healthy" --format "{{.Names}}" | sort)
            if echo "$HEALTHY" | grep -q "polis-gate" && \
               echo "$HEALTHY" | grep -q "polis-sentinel" && \
               echo "$HEALTHY" | grep -q "polis-state" && \
               echo "$HEALTHY" | grep -q "polis-toolbox" && \
               echo "$HEALTHY" | grep -q "polis-workspace"; then
              echo "All containers healthy"
              exit 0
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done
          echo "Timeout" && docker ps -a && exit 1

      - name: Run integration tests
        run: ./tests/run-tests.sh --ci integration

      - name: Show logs on failure
        if: failure()
        run: |
          for c in polis-gate polis-sentinel polis-scanner polis-state polis-toolbox polis-workspace; do
            echo "=== $c ===" && docker logs "$c" 2>&1 | tail -30 || true
          done
          docker ps -a

  e2e-tests:
    runs-on: ubuntu-24.04
    needs: integration-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Install sysbox
        run: |
          wget -q "https://downloads.nestybox.com/sysbox/releases/v${SYSBOX_VERSION}/sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb"
          sudo apt-get install -y jq "./sysbox-ce_${SYSBOX_VERSION}-0.linux_amd64.deb"
          sudo mkdir -p /etc/docker
          echo '{"runtimes":{"sysbox-runc":{"path":"/usr/bin/sysbox-runc"}}}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker

      - name: Setup certificates and secrets
        run: |
          chmod +x ./cli/polis.sh ./services/*/scripts/*.sh ./agents/openclaw/install.sh ./agents/openclaw/scripts/*.sh ./tools/*.sh ./scripts/*.sh ./tests/run-tests.sh
          ./cli/polis.sh setup-ca
          ./services/state/scripts/generate-certs.sh ./certs/valkey
          # Certs need 644 for cross-UID bind-mount access
          chmod 644 ./certs/valkey/*.crt
          # Keys: add read for container UIDs (bind-mount); CI-only — production should use per-service secrets
          chmod a+r ./certs/valkey/*.key
          touch .env
          ./services/state/scripts/generate-secrets.sh ./secrets .
          chmod 644 ./secrets/valkey_users.acl

      - name: Build and start containers
        run: |
          ./cli/polis.sh build
          ./cli/polis.sh up

      - name: Wait for healthy
        run: |
          for i in $(seq 1 60); do
            HEALTHY=$(docker ps --filter "health=healthy" --format "{{.Names}}" | sort)
            if echo "$HEALTHY" | grep -q "polis-gate" && \
               echo "$HEALTHY" | grep -q "polis-sentinel" && \
               echo "$HEALTHY" | grep -q "polis-state" && \
               echo "$HEALTHY" | grep -q "polis-toolbox" && \
               echo "$HEALTHY" | grep -q "polis-workspace"; then
              echo "All containers healthy"
              exit 0
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done
          echo "Timeout" && docker ps -a && exit 1

      - name: Run E2E tests
        run: ./tests/run-tests.sh --ci e2e

      - name: Show logs on failure
        if: failure()
        run: |
          for c in polis-gate polis-sentinel polis-scanner polis-state polis-toolbox polis-workspace; do
            echo "=== $c ===" && docker logs "$c" 2>&1 | tail -30 || true
          done
          docker ps -a
