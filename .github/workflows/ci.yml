name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0
        with:
          platforms: linux/amd64

      - name: Cleanup existing Docker containers
        run: docker rm $(docker ps -a -q) -f || true

      - name: Install sysbox
        run: |
          wget https://downloads.nestybox.com/sysbox/releases/v0.6.7/sysbox-ce_0.6.7-0.linux_amd64.deb
          sudo apt-get install -y jq ./sysbox-ce_0.6.7-0.linux_amd64.deb
          
          # Configure Docker to use sysbox runtime
          sudo mkdir -p /etc/docker
          echo '{"runtimes":{"sysbox-runc":{"path":"/usr/bin/sysbox-runc"}}}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          
          # Verify sysbox is available
          docker info | grep -i sysbox

      - name: Set script permissions
        run: |
          chmod +x ./tools/polis.sh
          chmod +x ./tools/*.sh
          chmod +x ./tests/run-tests.sh
          chmod +x ./scripts/*.sh
          chmod +x ./agents/openclaw/install.sh
          chmod +x ./agents/openclaw/scripts/*.sh

      - name: Setup CA certificates
        run: ./tools/polis.sh setup-ca

      - name: Setup Valkey TLS certificates
        run: ./scripts/generate-valkey-certs.sh ./certs/valkey

      - name: Setup Valkey secrets
        run: |
          touch .env
          ./scripts/generate-valkey-secrets.sh ./secrets .
          # Ensure ACL file is readable by Docker daemon for secret injection
          chmod 644 ./secrets/valkey_users.acl

      - name: Build containers
        run: ./tools/polis.sh build

      - name: Start containers
        run: ./tools/polis.sh up

      - name: Wait for healthy
        run: |
          for i in {1..60}; do
            HEALTHY=$(docker ps --filter "health=healthy" --format "{{.Names}}" | sort)
            echo "Healthy containers: $HEALTHY"
            if echo "$HEALTHY" | grep -q "polis-gateway" && \
               echo "$HEALTHY" | grep -q "polis-icap" && \
               echo "$HEALTHY" | grep -q "polis-v2-valkey" && \
               echo "$HEALTHY" | grep -q "polis-workspace"; then
              echo "All containers healthy"
              exit 0
            fi
            echo "Waiting for containers... ($i/60)"
            sleep 5
          done
          echo "Timeout waiting for containers"
          docker ps -a
          docker logs polis-v2-valkey 2>&1 | tail -30 || true
          docker logs polis-icap 2>&1 | tail -30 || true
          exit 1

      - name: Run tests
        run: ./tests/run-tests.sh --tap all

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Gateway ===" && docker logs polis-gateway 2>&1 | tail -50 || true
          echo "=== ICAP ===" && docker logs polis-icap 2>&1 | tail -50 || true
          echo "=== Valkey ===" && docker logs polis-v2-valkey 2>&1 | tail -50 || true
          echo "=== MCP-Agent ===" && docker logs polis-mcp-agent 2>&1 | tail -50 || true
          echo "=== Workspace ===" && docker logs polis-workspace 2>&1 | tail -50 || true
          echo "=== Container Status ===" && docker ps -a
