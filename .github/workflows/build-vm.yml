# Build VM Image Workflow
# Builds Polis VM image via Packer, generates checksums, attests provenance.
#
# Triggered on v* tags or manual workflow_dispatch.

name: Build VM Image

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., v0.3.0)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write
  attestations: write
  packages: read

env:
  SYSBOX_VERSION: "0.6.7"
  SYSBOX_SHA256_AMD64: "b7ac389e5a19592cadf16e0ca30e40919516128f6e1b7f99e1cb4ff64554172e"

jobs:
  # =========================================================
  # Build VM Image
  # =========================================================
  build-vm:
    name: "VM Image (${{ matrix.arch }})"
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        arch: [amd64]
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate CA certificate for build
        run: |
          mkdir -p certs/ca
          openssl genrsa -out certs/ca/ca.key 4096
          openssl req -new -x509 -days 3650 -key certs/ca/ca.key -out certs/ca/ca.pem \
            -subj "/C=US/ST=Local/L=Local/O=Polis/OU=Gateway/CN=Polis CA"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker images
        run: docker compose build

      - name: Export Docker images
        run: |
          set -euo pipefail
          IMAGES=$(grep -oP 'image:\s+\Kpolis-[a-z]+-oss:\S+' docker-compose.yml | sort -u)
          if [[ -z "${IMAGES}" ]]; then
            echo "::error::No polis-*-oss images found in docker-compose.yml"
            exit 1
          fi
          mkdir -p .build
          chmod 700 .build
          echo "Exporting: ${IMAGES}"
          # shellcheck disable=SC2086
          docker save -o .build/polis-images.tar ${IMAGES}

      - name: Setup Packer
        uses: hashicorp/setup-packer@1aa358be5cf73883762b302a3a03abd66e75b232 # v3.1.0

      - name: Init Packer
        run: packer init packer/

      - name: Build VM image
        run: |
          packer build \
            -var "polis_version=${{ steps.version.outputs.version }}" \
            -var "images_tar=${PWD}/.build/polis-images.tar" \
            -var "sysbox_version=${SYSBOX_VERSION}" \
            -var "sysbox_sha256_amd64=${SYSBOX_SHA256_AMD64}" \
            -var "arch=${{ matrix.arch }}" \
            packer/polis-vm.pkr.hcl

      - name: Generate checksum
        run: |
          cd output
          sha256sum *.qcow2 > checksums.sha256
          cat checksums.sha256

      - name: Attest VM image provenance
        uses: actions/attest-build-provenance@7668571508540a607bdfd90a87a560489fe372eb # v2.1.0
        with:
          subject-path: output/*.qcow2

      - name: Upload VM artifact
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: vm-image-${{ matrix.arch }}
          path: |
            output/*.qcow2
            output/checksums.sha256
          retention-days: 5

  # =========================================================
  # Release VM Images (tag push only)
  # =========================================================
  release-vm:
    name: Release VM Images
    needs: build-vm
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Download VM artifacts
        uses: actions/download-artifact@b14cf4c92620c250e1c074ab0a5800e37df86765 # v4.2.0
        with:
          pattern: vm-image-*
          merge-multiple: true
          path: ./vm-images

      - name: Upload to Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            vm-images/*.qcow2
            vm-images/checksums.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
