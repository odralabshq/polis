#!/usr/bin/env bats
# bats file_tags=e2e,scanning
# Malware detection via ClamAV through the full ICAP scanning pipeline

setup_file() {
    load "../../lib/test_helper.bash"
    load "../../lib/constants.bash"
    load "../../lib/guards.bash"
    require_container "$CTR_WORKSPACE" "$CTR_SENTINEL" "$CTR_SCANNER" "$CTR_GATE"
    relax_security_level 120
}

teardown_file() {
    load "../../lib/test_helper.bash"
    load "../../lib/constants.bash"
    load "../../lib/guards.bash"
    restore_security_level
}

setup() {
    load "../../lib/test_helper.bash"
    load "../../lib/constants.bash"
    load "../../lib/guards.bash"

    # Standard EICAR test string — single quotes prevent $ expansion
    EICAR='X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'
}

# =============================================================================
# Clean traffic
# =============================================================================

@test "e2e: clean HTTP file passes through proxy" {
    run docker exec "$CTR_WORKSPACE" \
        curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 15 \
        --proxy "$HTTP_PROXY_VIA_GATE" "http://${HTTPBIN_HOST}/get"
    assert_success
    assert_output "200"
}

@test "e2e: clean HTTPS file passes through proxy" {
    run_with_network_skip "httpbin.org" \
        docker exec "$CTR_WORKSPACE" \
        curl -sf -o /dev/null -w "%{http_code}" --connect-timeout 15 \
        https://httpbin.org/robots.txt
    assert_success
    assert_output "200"
}

# =============================================================================
# EICAR detection
# =============================================================================

@test "e2e: ClamAV detects EICAR pattern" {
    # clamdscan returns exit 1 when virus found
    run docker exec "$CTR_SCANNER" sh -c "echo '${EICAR}' | clamdscan -"
    assert_failure
    assert_output --partial "FOUND"
}

@test "e2e: EICAR download from eicar.org is blocked" {
    run_with_network_skip "secure.eicar.org" \
        docker exec "$CTR_WORKSPACE" \
        curl -s -o /dev/null -w "%{http_code}" --connect-timeout 15 \
        https://secure.eicar.org/eicar.com.txt
    # Blocked by ICAP scanning — should not return 200
    [[ "$output" != "200" ]]
}

@test "e2e: malware renamed as .png is detected" {
    run docker exec "$CTR_SCANNER" sh -c \
        "echo '${EICAR}' > /tmp/test.png && clamdscan /tmp/test.png; ret=\$?; rm -f /tmp/test.png; exit \$ret"
    assert_failure
    assert_output --partial "FOUND"
}

@test "e2e: EICAR with spoofed Content-Type (.mp4) is detected" {
    run docker exec "$CTR_SCANNER" sh -c \
        "echo '${EICAR}' > /tmp/test.mp4 && clamdscan /tmp/test.mp4; ret=\$?; rm -f /tmp/test.mp4; exit \$ret"
    assert_failure
    assert_output --partial "FOUND"
}

# =============================================================================
# Signature databases
# =============================================================================

@test "e2e: ClamAV has main signature database" {
    run docker exec "$CTR_SCANNER" test -f /var/lib/clamav/main.cvd
    assert_success
}

@test "e2e: ClamAV has daily signatures" {
    run docker exec "$CTR_SCANNER" sh -c \
        "test -f /var/lib/clamav/daily.cvd || test -f /var/lib/clamav/daily.cld"
    assert_success
}

# =============================================================================
# Connectivity
# =============================================================================

@test "e2e: sentinel can reach ClamAV (PING/PONG)" {
    # Source: squidclamav.conf → clamd_ip scanner, clamd_port 3310
    local scanner_ip
    scanner_ip=$(docker inspect -f '{{(index .NetworkSettings.Networks "polis_gateway-bridge").IPAddress}}' "$CTR_SCANNER")
    run bash -c "echo PING | nc -q1 $scanner_ip 3310"
    assert_success
    assert_output "PONG"
}

@test "e2e: ClamAV responds within timeout" {
    # Source: squidclamav.conf → timeout 3
    local scanner_ip
    scanner_ip=$(docker inspect -f '{{(index .NetworkSettings.Networks "polis_gateway-bridge").IPAddress}}' "$CTR_SCANNER")
    run bash -c "timeout 3 sh -c 'echo VERSION | nc -q1 $scanner_ip 3310'"
    assert_success
    assert_output --partial "ClamAV"
}
