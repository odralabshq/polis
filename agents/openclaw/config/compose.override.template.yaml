# Compose override for OpenClaw agent — mounts agent scripts into workspace.
# Generated by `just setup-agents` from this template.
#
# To use the pre-built OpenClaw image instead of runtime install, build first:
#   docker compose -f docker-compose.yml -f agents/openclaw/.generated/compose.override.yaml \
#     build workspace --build-arg WORKSPACE_IMAGE=ghcr.io/odralabshq/polis-workspace-oss:latest
services:
  workspace:
    ports:
      - "${OPENCLAW_HOST_PORT:-18789}:18789"
    healthcheck:
      test: ["CMD-SHELL", "systemctl is-active polis-init.service && ip route | grep -q default"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s
    env_file:
      - .env
    networks:
      internal-bridge:
        ipv4_address: 10.10.1.30
    volumes:
      - ./agents/openclaw/scripts/:/tmp/agents/openclaw/scripts/:ro
      - ./agents/openclaw/config/:/tmp/agents/openclaw/config/:ro
      - ./agents/openclaw/.generated/openclaw.service:/etc/systemd/system/openclaw.service:ro
      - ./agents/openclaw/.generated/openclaw.service.sha256:/etc/systemd/system/openclaw.service.sha256:ro
      - ./agents/openclaw/.generated/openclaw.env:/run/openclaw-env:ro

  # Extend host-init to also enable route_localnet for OpenClaw localhost forwarding
  host-init:
    command:
      - sh
      - -c
      - |
        INT_BR="br-$(docker network inspect polis_internal-bridge --format '{{.Id}}' | cut -c1-12)"
        iptables -C DOCKER-USER -i "$INT_BR" -o "$INT_BR" -j ACCEPT 2>/dev/null ||
        iptables -I DOCKER-USER -i "$INT_BR" -o "$INT_BR" -j ACCEPT
        sysctl -w net.ipv4.conf.all.route_localnet=1 || true

  # Socat TCP proxy — creates a real listener on the host network so
  # Hyper-V / Multipass virtual switches can route traffic to the
  # sysbox workspace container (iptables DNAT alone is invisible to them).
  # Workspace is assigned static IP 10.10.1.30 in this override.
  openclaw-port-forward:
    image: alpine/socat:1.8.0.1
    container_name: polis-openclaw-fwd
    network_mode: host
    depends_on:
      workspace:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        PORT=${OPENCLAW_HOST_PORT:-18789}
        echo "Proxying 0.0.0.0:$PORT -> 10.10.1.30:18789 via socat"
        exec socat TCP-LISTEN:$PORT,bind=0.0.0.0,fork,reuseaddr TCP:10.10.1.30:18789
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "2"
