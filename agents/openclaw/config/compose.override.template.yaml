# CI-generated minimal override — mounts agent scripts into workspace
# Full override is generated by the polis CLI on first run
services:
  workspace:
    ports:
      - "${OPENCLAW_HOST_PORT:-18789}:18789"
    # Extend health timeout — OpenClaw install takes ~3-5 min on first boot
    healthcheck:
      test: ["CMD-SHELL", "systemctl is-active polis-init.service && ip route | grep -q default"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s
    env_file:
      - .env
    volumes:
      - ./agents/openclaw/:/tmp/agents/openclaw/:ro
      - ./agents/openclaw/.generated/openclaw.service:/etc/systemd/system/openclaw.service:ro
      - ./agents/openclaw/.generated/openclaw.service.sha256:/etc/systemd/system/openclaw.service.sha256:ro
      - ./agents/openclaw/.generated/openclaw.env:/run/openclaw-env:ro

  # Extend host-init to also enable route_localnet for OpenClaw localhost forwarding
  host-init:
    command:
      - sh
      - -c
      - |
        INT_BR="br-$(docker network inspect polis_internal-bridge --format '{{.Id}}' | cut -c1-12)"
        iptables -C DOCKER-USER -i "$INT_BR" -o "$INT_BR" -j ACCEPT 2>/dev/null ||
        iptables -I DOCKER-USER -i "$INT_BR" -o "$INT_BR" -j ACCEPT
        sysctl -w net.ipv4.conf.all.route_localnet=1 || true

  # Socat TCP proxy — creates a real listener on the host network so
  # Hyper-V / Multipass virtual switches can route traffic to the
  # sysbox workspace container (iptables DNAT alone is invisible to them).
  openclaw-port-forward:
    image: alpine/socat:1.8.0.1
    container_name: polis-openclaw-fwd
    network_mode: host
    depends_on:
      workspace:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        WS_IP=$(printf 'GET /containers/polis-workspace/json HTTP/1.0\r\nHost: localhost\r\n\r\n' \
          | socat - UNIX-CONNECT:/var/run/docker.sock 2>/dev/null \
          | grep -o '"IPAddress":"[0-9.]*"' | head -1 | grep -o '[0-9.]*')
        if [ -z "$WS_IP" ]; then echo "ERROR: Could not resolve workspace IP"; exit 1; fi
        PORT=${OPENCLAW_HOST_PORT:-18789}
        echo "Proxying 0.0.0.0:$PORT -> $WS_IP:18789 via socat"
        exec socat TCP-LISTEN:$PORT,bind=0.0.0.0,fork,reuseaddr TCP:$WS_IP:18789
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "2"
