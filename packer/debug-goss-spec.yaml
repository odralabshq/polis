DEBUG: file after text/template render
# goss.yaml - Main Goss test file for Polis VM image validation
# Includes all component test files

gossfile:
  goss-docker.yaml: {}
  goss-sysbox.yaml: {}
  goss-hardening.yaml: {}
  goss-polis.yaml: {}

DEBUG: file after text/template render
# goss-docker.yaml - Docker installation validation

package:
  docker-ce:
    installed: true
  docker-ce-cli:
    installed: true
  containerd.io:
    installed: true

service:
  docker:
    enabled: true
    running: true

file:
  /etc/docker/daemon.json:
    exists: true
    mode: "0644"
    contents:
      - '"no-new-privileges": true'
      - '"live-restore": true'
      - '"userland-proxy": false'
      - sysbox-runc

  /etc/apt/keyrings/docker.asc:
    exists: true

command:
  docker-version:
    exec: "docker --version"
    exit-status: 0
    stdout:
      - "Docker version"

  docker-info:
    exec: "sudo docker info 2>/dev/null | grep -i runtime"
    exit-status: 0
    stdout:
      - sysbox-runc

DEBUG: file after text/template render
# goss-hardening.yaml - VM hardening validation (CIS-aligned)

file:
  /etc/sysctl.d/99-polis-hardening.conf:
    exists: true
    contents:
      - "kernel.randomize_va_space = 2"
      - "kernel.dmesg_restrict = 1"
      - "kernel.kptr_restrict = 2"
      - "fs.suid_dumpable = 0"
      - "kernel.yama.ptrace_scope = 2"

  /etc/audit/rules.d/docker.rules:
    exists: true
    skip: true

package:
  auditd:
    installed: true

service:
  apparmor:
    enabled: true
    running: true

  auditd:
    enabled: true
    running: true

# Verify sysctl values are applied
command:
  sysctl-aslr:
    exec: "sysctl -n kernel.randomize_va_space"
    exit-status: 0
    stdout:
      - "2"

  sysctl-dmesg:
    exec: "sysctl -n kernel.dmesg_restrict"
    exit-status: 0
    stdout:
      - "1"

  sysctl-kptr:
    exec: "sysctl -n kernel.kptr_restrict"
    exit-status: 0
    stdout:
      - "2"

# NOTE: ubuntu-locked and root-locked tests removed - password locking happens
# in cleanup provisioner AFTER Goss tests run. Verified by cleanup step itself.

DEBUG: file after text/template render
# goss-polis.yaml - Polis installation validation

file:
  # Core files
  /opt/polis/docker-compose.yml:
    exists: true

  /opt/polis/config/polis.yaml:
    exists: true

  /opt/polis/scripts/setup-certs.sh:
    exists: true
    mode: "0755"

  # Service configs
  /opt/polis/services/gate/config/g3proxy.yaml:
    exists: true

  /opt/polis/services/sentinel/config/c-icap.conf:
    exists: true

  /opt/polis/services/resolver/config/Corefile:
    exists: true

  /opt/polis/services/state/config/valkey.conf:
    exists: true

  # Systemd service
  /etc/systemd/system/polis.service:
    exists: true
    contents:
      - "After=docker.service"
      - "ExecStart=/usr/bin/docker compose up -d"

# Polis systemd service enabled (not running - starts on boot)
service:
  polis:
    enabled: true

# Docker images loaded (sudo required - group membership not active in Packer SSH session)
command:
  images-resolver:
    exec: "sudo docker images | grep -q polis-resolver-oss"
    exit-status: 0

  images-gate:
    exec: "sudo docker images | grep -q polis-gate-oss"
    exit-status: 0

  images-sentinel:
    exec: "sudo docker images | grep -q polis-sentinel-oss"
    exit-status: 0

  images-scanner:
    exec: "sudo docker images | grep -q polis-scanner-oss"
    exit-status: 0

  images-workspace:
    exec: "sudo docker images | grep -q polis-workspace-oss"
    exit-status: 0

  images-toolbox:
    exec: "sudo docker images | grep -q polis-toolbox-oss"
    exit-status: 0

# netcat installed for SSH proxy
package:
  netcat-openbsd:
    installed: true

DEBUG: file after text/template render
# goss-sysbox.yaml - Sysbox runtime validation

package:
  sysbox-ce:
    installed: true

service:
  sysbox:
    enabled: true
    running: true

file:
  /usr/bin/sysbox-runc:
    exists: true
    mode: "0755"

  /usr/bin/sysbox-mgr:
    exists: true

  /usr/bin/sysbox-fs:
    exists: true

command:
  sysbox-runc-version:
    exec: "sysbox-runc --version"
    exit-status: 0
    stdout:
      - "sysbox-runc"

file:
  /etc/apt/keyrings/docker.asc:
    exists: true
    contents: null
  /etc/audit/rules.d/docker.rules:
    exists: true
    contents: null
    skip: true
  /etc/docker/daemon.json:
    exists: true
    mode: "0644"
    contents:
    - '"no-new-privileges": true'
    - '"live-restore": true'
    - '"userland-proxy": false'
    - sysbox-runc
  /etc/sysctl.d/99-polis-hardening.conf:
    exists: true
    contents:
    - kernel.randomize_va_space = 2
    - kernel.dmesg_restrict = 1
    - kernel.kptr_restrict = 2
    - fs.suid_dumpable = 0
    - kernel.yama.ptrace_scope = 2
  /etc/systemd/system/polis.service:
    exists: true
    contents:
    - After=docker.service
    - ExecStart=/usr/bin/docker compose up -d
  /opt/polis/config/polis.yaml:
    exists: true
    contents: null
  /opt/polis/docker-compose.yml:
    exists: true
    contents: null
  /opt/polis/scripts/setup-certs.sh:
    exists: true
    mode: "0755"
    contents: null
  /opt/polis/services/gate/config/g3proxy.yaml:
    exists: true
    contents: null
  /opt/polis/services/resolver/config/Corefile:
    exists: true
    contents: null
  /opt/polis/services/sentinel/config/c-icap.conf:
    exists: true
    contents: null
  /opt/polis/services/state/config/valkey.conf:
    exists: true
    contents: null
  /usr/bin/sysbox-fs:
    exists: true
    contents: null
  /usr/bin/sysbox-mgr:
    exists: true
    contents: null
  /usr/bin/sysbox-runc:
    exists: true
    mode: "0755"
    contents: null
package:
  auditd:
    installed: true
  containerd.io:
    installed: true
  docker-ce:
    installed: true
  docker-ce-cli:
    installed: true
  netcat-openbsd:
    installed: true
  sysbox-ce:
    installed: true
service:
  apparmor:
    enabled: true
    running: true
  auditd:
    enabled: true
    running: true
  docker:
    enabled: true
    running: true
  polis:
    enabled: true
    running: null
  sysbox:
    enabled: true
    running: true
command:
  docker-info:
    exec: sudo docker info 2>/dev/null | grep -i runtime
    exit-status: 0
    stdout:
    - sysbox-runc
    stderr: null
    timeout: 0
  docker-version:
    exec: docker --version
    exit-status: 0
    stdout:
    - Docker version
    stderr: null
    timeout: 0
  images-gate:
    exec: sudo docker images | grep -q polis-gate-oss
    exit-status: 0
    stdout: null
    stderr: null
    timeout: 0
  images-resolver:
    exec: sudo docker images | grep -q polis-resolver-oss
    exit-status: 0
    stdout: null
    stderr: null
    timeout: 0
  images-scanner:
    exec: sudo docker images | grep -q polis-scanner-oss
    exit-status: 0
    stdout: null
    stderr: null
    timeout: 0
  images-sentinel:
    exec: sudo docker images | grep -q polis-sentinel-oss
    exit-status: 0
    stdout: null
    stderr: null
    timeout: 0
  images-toolbox:
    exec: sudo docker images | grep -q polis-toolbox-oss
    exit-status: 0
    stdout: null
    stderr: null
    timeout: 0
  images-workspace:
    exec: sudo docker images | grep -q polis-workspace-oss
    exit-status: 0
    stdout: null
    stderr: null
    timeout: 0
  sysbox-runc-version:
    exec: sysbox-runc --version
    exit-status: 0
    stdout:
    - sysbox-runc
    stderr: null
    timeout: 0
  sysctl-aslr:
    exec: sysctl -n kernel.randomize_va_space
    exit-status: 0
    stdout:
    - "2"
    stderr: null
    timeout: 0
  sysctl-dmesg:
    exec: sysctl -n kernel.dmesg_restrict
    exit-status: 0
    stdout:
    - "1"
    stderr: null
    timeout: 0
  sysctl-kptr:
    exec: sysctl -n kernel.kptr_restrict
    exit-status: 0
    stdout:
    - "2"
    stderr: null
    timeout: 0
