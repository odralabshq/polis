services:
  # =========================================================
  # G3PROXY GATEWAY (Tier 1 Entry Point)
  # =========================================================
  gateway:
    build:
      context: ..
      dockerfile: ./build/g3proxy/Dockerfile
    image: polis-gateway-oss:latest
    container_name: polis-gateway
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SETUID
      - SETGID
    cap_drop:
      - ALL
    security_opt:
      - seccomp=../config/seccomp/gateway.json
    networks:
      internal-bridge: {}
      gateway-bridge: {}
      external-bridge: {}
    volumes:
      - ../config/g3proxy.yaml:/etc/g3proxy/g3proxy.yaml:ro
      - ../config/g3fcgen.yaml:/etc/g3proxy/g3fcgen.yaml:ro
      - ../scripts/g3proxy-init.sh:/init.sh:ro
      - ../certs/ca:/etc/g3proxy/ssl:ro
      - ../scripts/health-check.sh:/scripts/health-check.sh:ro
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.ip_nonlocal_bind=1
      - net.ipv4.conf.all.rp_filter=0
    depends_on:
      - icap
    healthcheck:
      test: ["CMD", "/scripts/health-check.sh"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service"
    labels:
      service: "polis-gateway"

  # =========================================================
  # C-ICAP (Content Inspection)
  # =========================================================
  icap:
    build:
      context: ..
      dockerfile: ./build/icap/Dockerfile
    image: polis-icap-oss:latest
    container_name: polis-icap
    security_opt:
      - no-new-privileges:true
    networks:
      gateway-bridge: {}
    volumes:
      - ../config/c-icap.conf:/etc/c-icap/c-icap.conf:ro
      - ../config/squidclamav.conf:/etc/squidclamav.conf:ro
    depends_on:
      clamav:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x c-icap > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service"
    labels:
      service: "polis-icap"

  # =========================================================
  # CLAMAV (Malware Scanning)
  # =========================================================
  clamav:
    image: clamav/clamav:1.5.1
    container_name: polis-clamav
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777
      - /var/log/clamav:size=50M,mode=755
      - /run/clamav:size=10M,mode=755
      - /var/lock:size=10M,mode=1777
    networks:
      gateway-bridge: {}
    volumes:
      - clamav-db:/var/lib/clamav
      - ../config/freshclam.conf:/etc/clamav/freshclam.conf:ro
    environment:
      - CLAMAV_NO_FRESHCLAMD=false
      - CLAMAV_NO_MILTERD=true
    healthcheck:
      test: ["CMD", "clamdscan", "--ping", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service"
    labels:
      service: "polis-clamav"
    deploy:
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 1G

  # =========================================================
  # WORKSPACE (agent selected via POLIS_AGENT image tag)
  # =========================================================
  workspace:
    image: polis-workspace-oss:${POLIS_AGENT:-latest}
    container_name: polis-workspace
    runtime: sysbox-runc
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      internal-bridge: {}
    env_file:
      - ../.env
    volumes:
      - ../certs/ca/ca.pem:/usr/local/share/ca-certificates/polis-ca.crt:ro
      - ../scripts/workspace-init.sh:/usr/local/bin/polis-init.sh:ro
      - ../config/polis-init.service:/etc/systemd/system/polis-init.service:ro
    healthcheck:
      test: ["CMD-SHELL", "systemctl is-active polis-init.service && ip route | grep -q default"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service"
    labels:
      service: "polis-workspace"

networks:
  internal-bridge:
    enable_ipv6: false
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.10.1.0/24

  gateway-bridge:
    enable_ipv6: false
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.30.1.0/24

  external-bridge:
    enable_ipv6: false
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.20.1.0/24

volumes:
  clamav-db:
    name: polis-clamav-db
  # Uncomment to persist OpenClaw data across container restarts
  # openclaw-data:
  #   name: polis-openclaw-data
