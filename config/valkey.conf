# =============================================================================
# Valkey 8 Configuration — Molis OSS
# =============================================================================
# Production-hardened configuration for the Molis state management backend.
# Mounted read-only into the container at /etc/valkey/valkey.conf.
# =============================================================================

# -----------------------------------------------------------------------------
# TLS Configuration
# Requirements: 2.1 — TLS-only connections with client certificate auth
# -----------------------------------------------------------------------------
tls-port 6379
port 0
tls-cert-file /etc/valkey/tls/server.crt
tls-key-file /etc/valkey/tls/server.key
tls-ca-cert-file /etc/valkey/tls/ca.crt
tls-auth-clients yes

# -----------------------------------------------------------------------------
# Network Configuration
# Requirements: 2.1 — Bind to all container interfaces (network isolation
# is enforced by Docker networks, not by bind address)
# Note: Redis/Valkey bind directive accepts IPs only, not hostnames.
# -----------------------------------------------------------------------------
bind 0.0.0.0
protected-mode yes

# -----------------------------------------------------------------------------
# ACL Configuration
# Requirements: 2.2 — File-based ACL authentication
# -----------------------------------------------------------------------------
aclfile /run/secrets/valkey_acl

# -----------------------------------------------------------------------------
# Dangerous Command Restrictions
# Requirements: 2.6 — Restrict dangerous commands via ACL (not rename-command)
# Note: rename-command is deprecated in favor of ACLs in Valkey 8.
# All dangerous commands are denied per-user in the ACL file.
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# Memory Management
# Requirements: 2.3 — 256MB limit with volatile-lru eviction
# -----------------------------------------------------------------------------
maxmemory 256mb
maxmemory-policy volatile-lru

# -----------------------------------------------------------------------------
# Persistence — AOF
# Requirements: 2.4 — AOF with everysec fsync, data stored in /data
# -----------------------------------------------------------------------------
appendonly yes
appendfsync everysec
appendfilename "molis.aof"
dir /data

# -----------------------------------------------------------------------------
# Persistence — RDB Snapshots
# Requirements: 2.5 — RDB at 900/1, 300/10, 60/10000
# -----------------------------------------------------------------------------
save 900 1
save 300 10
save 60 10000
dbfilename molis.rdb

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
loglevel notice
logfile ""

# -----------------------------------------------------------------------------
# Connection Limits
# Requirements: 2.8 — 100 max clients, 300s idle timeout
# -----------------------------------------------------------------------------
maxclients 100
timeout 300
tcp-keepalive 300

# Client output buffer limits
# Normal clients: 0 (unlimited) with no soft/hard limits
# Replica clients: 256mb hard, 64mb/60s soft
# Pub/Sub clients: 32mb hard, 8mb/60s soft
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# -----------------------------------------------------------------------------
# Multi-threading
# Requirements: 2.7 — 4 IO threads with read offloading
# -----------------------------------------------------------------------------
io-threads 4
io-threads-do-reads yes
