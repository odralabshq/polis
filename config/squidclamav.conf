# SquidClamav Configuration for polis v0.2.5
# Fail-closed malware scanning with URL whitelisting for trusted repos

# ClamAV daemon connection (TCP for Docker networking)
clamd_ip clamav
clamd_port 3310

# Connection timeout (seconds)
timeout 3

# Maximum file size to scan. Must be <= clamd StreamMaxLength (both 50M).
# Files exceeding this from non-whitelisted sources trigger fail-closed error.
maxsize 50M

# Disable DNS lookup (performance; we don't use trustclient with hostnames)
dnslookup 0

# Log all virus detections to c-icap log
logredir 1

# Scan everything except explicit whitelist/abort exclusions
scan_mode ScanAllExcept

# ---------------------------------------------------------------------------
# URL Whitelisting — trusted package repositories
# ---------------------------------------------------------------------------
# These repos have their own integrity controls (GPG signatures, lockfile
# hashes, content-addressable storage) that are stronger than inline AV.
# Whitelisting by destination domain avoids the spoofing risk of
# abort/abortcontent (which match extensions/MIME types the server controls).
#
# Debian/apt (GPG-signed Release files + package hashes)
whitelist .*deb\.debian\.org
whitelist .*deb\.nodesource\.com
# npm (integrity hashes verified by pnpm --frozen-lockfile)
whitelist .*registry\.npmjs\.org
# GitHub (TLS-verified, content-addressable git objects)
whitelist .*github\.com
whitelist .*objects\.githubusercontent\.com
# Bun runtime installer
whitelist .*bun\.sh

# ---------------------------------------------------------------------------
# No abort/abortcontent directives — scan ALL content types from
# non-whitelisted sources. ClamAV uses magic bytes, not extensions/MIME.
# ---------------------------------------------------------------------------

# Force-scan high-risk types even in ScanNothingExcept mode (defense-in-depth)
scan .*\.(exe|dll|msi|bat|cmd|ps1|vbs|js|jar|zip|rar|7z|tar|gz|doc|docx|xls|xlsx|ppt|pptx|pdf)$
