
==========================================
  Polis Test Suite
==========================================

[0;32m[INFO][0m Running: /home/tomasz/odralabshq/polis/tests/integration /home/tomasz/odralabshq/polis/services/gate/tests/integration /home/tomasz/odralabshq/polis/services/resolver/tests/integration /home/tomasz/odralabshq/polis/services/scanner/tests/integration /home/tomasz/odralabshq/polis/services/sentinel/tests/integration /home/tomasz/odralabshq/polis/services/toolbox/tests/integration /home/tomasz/odralabshq/polis/services/workspace/tests/integration /home/tomasz/odralabshq/polis/agents/openclaw/tests/integration

1..238
ok 1 ipv6: workspace has no global IPv6 addresses
ok 2 ipv6: gateway has no global IPv6 addresses
ok 3 ipv6: gateway ip6tables filter DROP policy # skip ip6tables not functional in this environment
ok 4 isolation: icap cannot reach workspace directly
ok 5 isolation: internal-bridge has IPv6 disabled
ok 6 config: g3proxy resolver uses CoreDNS at 10.30.1.10
ok 7 config: g3proxy ICAP reqmod service configured
ok 8 config: g3proxy ICAP respmod service configured
ok 9 config: g3proxy TLS cert agent on port 2999
ok 10 config: g3proxy server listens on 0.0.0.0:18080 (TPROXY requirement)
ok 11 config: g3proxy audit ratio is 1.0 (all traffic)
ok 12 config: g3proxy uses direct escaper
ok 13 config: seccomp default action is ERRNO (deny by default)
ok 14 config: seccomp supports x86_64 architecture
ok 15 config: seccomp supports aarch64 architecture
ok 16 config: seccomp allows setsockopt (required for TPROXY)
ok 17 config: seccomp allows socket syscall
ok 18 config: seccomp allows mount syscall (for init)
ok 19 config: gateway g3proxy.yaml mounted read-only
ok 20 config: gateway g3fcgen.yaml mounted
ok 21 config: gateway init script mounted
not ok 22 tproxy: G3TPROXY chain exists in mangle table
# (from function `assert_success' in file tests/bats/bats-assert/src/assert_success.bash, line 45,
#  in test file services/gate/tests/integration/networking.bats, line 15)
#   `assert_success' failed
#
# -- command failed --
# status : 4
# output : iptables v1.8.11 (nf_tables): Could not fetch rule set generation id: Permission denied (you must be root)
# --
#
not ok 23 tproxy: TPROXY redirects to port 18080
# (from function `assert_success' in file tests/bats/bats-assert/src/assert_success.bash, line 45,
#  in test file services/gate/tests/integration/networking.bats, line 20)
#   `assert_success' failed
#
# -- command failed --
# status : 4
# output : iptables v1.8.11 (nf_tables): Could not fetch rule set generation id: Permission denied (you must be root)
# --
#
ok 24 tproxy: g3proxy listening on port 18080
ok 25 tproxy: ip rule for fwmark 0x1 exists
ok 26 tproxy: routing table 100 has local route
ok 27 network: gateway has IP forwarding enabled
ok 28 network: gateway can resolve icap via DNS
ok 29 resilience: gateway has healthcheck configured
ok 30 resilience: health-check.sh mounted in gateway
ok 31 resilience: gateway currently healthy
ok 32 resilience: gateway uses json-file logging driver
ok 33 resilience: gateway restart policy is unless-stopped
ok 34 resilience: gateway init starts g3fcgen before g3proxy
ok 35 security: gateway is NOT running privileged
ok 36 security: gateway has NET_ADMIN capability
ok 37 security: gateway has NET_RAW capability
not ok 38 security: gateway has only required capabilities
# (in test file services/gate/tests/integration/security.bats, line 39)
#   `[[ "$cap_count" -eq 4 ]]' failed
not ok 39 security: gateway drops all capabilities except NET_ADMIN/NET_RAW
# (from function `__assert_stream' in file tests/bats/bats-assert/src/assert_output.bash, line 236,
#  from function `assert_output' in file tests/bats/bats-assert/src/assert_output.bash, line 125,
#  in test file services/gate/tests/integration/security.bats, line 45)
#   `assert_output --partial "ALL"' failed
#
# -- output does not contain substring --
# substring : ALL
# output    : []
# --
#
ok 40 privilege-drop: gateway Dockerfile creates g3proxy user
ok 41 privilege-drop: g3proxy process runs as g3proxy user
not ok 42 privilege-drop: g3proxy process has CAP_NET_ADMIN via ambient capabilities
# (from function `__assert_stream' in file tests/bats/bats-assert/src/assert_output.bash, line 236,
#  from function `assert_output' in file tests/bats/bats-assert/src/assert_output.bash, line 125,
#  in test file services/gate/tests/integration/security.bats, line 68)
#   `assert_output --partial "CapEff:	0000000000001000"' failed
#
# -- output does not contain substring --
# substring (1 lines):
#   CapEff:	0000000000001000
# output (59 lines):
#   Name:	g3proxy
#   Umask:	0022
#   State:	S (sleeping)
#   Tgid:	1
#   Ngid:	0
#   Pid:	1
#   PPid:	0
#   TracerPid:	0
#   Uid:	999	999	999	999
#   Gid:	999	999	999	999
#   FDSize:	256
#   Groups:	999
#   NStgid:	1
#   NSpid:	1
#   NSpgid:	1
#   NSsid:	1
#   Kthread:	0
#   VmPeak:	 6957428 kB
#   VmSize:	 6868436 kB
#   VmLck:	       0 kB
#   VmPin:	       0 kB
#   VmHWM:	   31232 kB
#   VmRSS:	   31232 kB
#   RssAnon:	   10752 kB
#   RssFile:	   20480 kB
#   RssShmem:	       0 kB
#   VmData:	  142008 kB
#   VmStk:	     140 kB
#   VmExe:	   25912 kB
#   VmLib:	   11272 kB
#   VmPTE:	     884 kB
#   VmSwap:	       0 kB
#   HugetlbPages:	       0 kB
#   CoreDumping:	0
#   THP_enabled:	1
#   untag_mask:	0xffffffffffffffff
#   Threads:	40
#   SigQ:	0/128329
#   SigPnd:	0000000000000000
#   ShdPnd:	0000000000000000
#   SigBlk:	0000000000000000
#   SigIgn:	0000000000001000
#   SigCgt:	0000000100004447
#   CapInh:	0000000000000000
#   CapPrm:	0000000000003000
#   CapEff:	0000000000003000
#   CapBnd:	00000000a80435fb
#   CapAmb:	0000000000000000
#   NoNewPrivs:	0
#   Seccomp:	2
#   Seccomp_filters:	1
#   Speculation_Store_Bypass:	thread vulnerable
#   SpeculationIndirectBranch:	conditional enabled
#   Cpus_allowed:	ffffffff
#   Cpus_allowed_list:	0-31
#   Mems_allowed:	00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000000,00000001
#   Mems_allowed_list:	0
#   voluntary_ctxt_switches:	39
#   nonvoluntary_ctxt_switches:	2
# --
#
ok 43 supply-chain: g3proxy Dockerfile has SHA256 verification
ok 44 supply-chain: g3proxy Dockerfile pins G3_SHA256 hash
ok 45 dns: container is running
ok 46 dns: container is healthy
ok 47 dns: has static IP 10.30.1.10
ok 48 dns: blocks webhook.site (exfiltration)
ok 49 dns: blocks ngrok.io (tunneling)
ok 50 dns: blocks ngrok-free.app (tunneling)
ok 51 dns: blocks transfer.sh (file sharing)
ok 52 dns: blocks burpcollaborator.net (OOB)
ok 53 dns: blocks githab.com (typosquatting)
ok 54 dns: resolves github.com
ok 55 dns: resolves api.github.com
ok 56 dns: resolves google.com
ok 57 dns: Corefile mounted at /etc/coredns/Corefile
ok 58 dns: blocklist mounted at /etc/coredns/blocklist.txt
ok 59 dns: no-new-privileges security opt
not ok 60 clamav: container exists
# (from function `__assert_stream' in file tests/bats/bats-assert/src/assert_output.bash, line 244,
#  from function `assert_output' in file tests/bats/bats-assert/src/assert_output.bash, line 125,
#  in test file services/scanner/tests/integration/clamav.bats, line 17)
#   `assert_output "${CLAMAV_CONTAINER}"' failed
#
# -- output differs --
# expected (1 lines):
#   polis-scanner
# actual (2 lines):
#   polis-scanner
#   polis-scanner-init
# --
#
ok 61 clamav: container is running
ok 62 clamav: container is healthy
ok 63 clamav: uses correct image version
ok 64 clamav: has no-new-privileges
ok 65 clamav: has cap_drop ALL
not ok 66 clamav: has required capabilities added back
# (from function `__assert_stream' in file tests/bats/bats-assert/src/assert_output.bash, line 236,
#  from function `assert_output' in file tests/bats/bats-assert/src/assert_output.bash, line 125,
#  in test file services/scanner/tests/integration/clamav.bats, line 58)
#   `assert_output --partial "SETGID"' failed
#
# -- output does not contain substring --
# substring : SETGID
# output    : [CAP_CHOWN]
# --
#
ok 67 clamav: filesystem is read-only
ok 68 clamav: has tmpfs mounts for writable directories
ok 69 clamav: listening on port 3310
ok 70 clamav: only on gateway-bridge network
ok 71 clamav: no ports exposed to host
ok 72 clamav: responds to PING command
ok 73 clamav: returns version info
not ok 74 clamav: signature database is loaded
# (from function `__assert_stream' in file tests/bats/bats-assert/src/assert_output.bash, line 236,
#  from function `assert_output' in file tests/bats/bats-assert/src/assert_output.bash, line 125,
#  in test file services/scanner/tests/integration/clamav.bats, line 119)
#   `assert_output --partial "daily.cvd"' failed
#
# -- output does not contain substring --
# substring (1 lines):
#   daily.cvd
# output (6 lines):
#   bytecode-339.cvd.sign
#   bytecode.cvd
#   daily.cld
#   freshclam.dat
#   main-63.cvd.sign
#   main.cvd
# --
#
ok 75 clamav: has memory limit configured
ok 76 clamav: has memory reservation configured
ok 77 squidclamav: module is loaded in c-icap
ok 78 squidclamav: config file exists
ok 79 squidclamav: config points to clamav host
ok 80 squidclamav: config uses port 3310
ok 81 squidclamav: ICAP service responds to OPTIONS
ok 82 squidclamav: service reports correct methods
ok 83 squidclamav: service identifies as SquidClamav
ok 84 g3proxy: RESPMOD configured for squidclamav
ok 85 g3proxy: REQMOD configured for credcheck
ok 86 healthcheck: gateway checks squidclamav service
ok 87 healthcheck: gateway can reach ICAP squidclamav
ok 88 healthcheck: gateway can reach ICAP echo
not ok 89 icap: has gosu installed
# (from function `assert_success' in file tests/bats/bats-assert/src/assert_success.bash, line 45,
#  in test file services/scanner/tests/integration/clamav.bats, line 229)
#   `assert_success' failed
#
# -- command failed --
# status : 1
# output :
# --
#
ok 90 icap: has netcat installed
ok 91 icap: squidclamav.so module exists
ok 92 icap: depends on clamav service
ok 93 clamav: freshclam.conf is mounted
ok 94 clamav: freshclam configured for database updates
ok 95 clamav: database volume is mounted
ok 96 clamav: database volume exists
ok 97 config: clamd.conf exists
ok 98 config: clamd listens on 0.0.0.0:3310
ok 99 config: c-icap StartServers is 3
ok 100 config: c-icap listens on 0.0.0.0:1344
ok 101 config: icap config mounted read-only
ok 102 icap-hardening: no Content-Type bypass directives (AC1)
ok 103 icap-hardening: Content-Type bypass removed from comments
ok 104 icap-hardening: all whitelist regexes are anchored (AC2)
ok 105 icap-hardening: whitelist regex format is correct
ok 106 icap-hardening: whitelist includes Debian repos
ok 107 icap-hardening: whitelist includes npm registry
ok 108 icap-hardening: whitelist includes Docker Hub
ok 109 icap-hardening: whitelist includes PyPI
ok 110 icap-hardening: whitelist includes crates.io
ok 111 icap-hardening: whitelist includes Go proxy
ok 112 icap-hardening: maxsize is 100M (AC3)
ok 113 icap-hardening: clamd StreamMaxLength matches architecture
ok 114 icap-hardening: clamd MaxFileSize matches architecture
ok 115 icap-hardening: clamd MaxScanSize is 400M
ok 116 icap-hardening: clamd AlertExceedsMax is enabled
ok 117 icap-hardening: ICAP tmpfs is 2GB (AC4)
ok 118 icap-hardening: ICAP has /var/log tmpfs
ok 119 icap-hardening: ICAP has /var/run/c-icap tmpfs
ok 120 icap-hardening: ICAP memory limit is 3GB (AC5)
ok 121 icap-hardening: ICAP memory reservation is 1GB
ok 122 icap-hardening: ClamAV has internet network (AC6)
ok 123 icap-hardening: ClamAV has gateway-bridge network
ok 124 icap-hardening: ICAP does NOT have internet network
ok 125 icap-hardening: ICAP health check uses c-icap-client (AC7)
ok 126 icap-hardening: ICAP health check interval is 30s
ok 127 icap-hardening: ICAP health check timeout is 10s
ok 128 icap-hardening: ICAP container is healthy (AC12)
ok 129 icap-hardening: ClamAV container is healthy
ok 130 icap-hardening: ICAP has no-new-privileges
ok 131 icap-hardening: ICAP has CHOWN capability
not ok 132 icap-hardening: ICAP has SETUID capability
# (from function `__assert_stream' in file tests/bats/bats-assert/src/assert_output.bash, line 236,
#  from function `assert_output' in file tests/bats/bats-assert/src/assert_output.bash, line 125,
#  in test file services/sentinel/tests/integration/icap-hardening.bats, line 225)
#   `assert_output --partial "SETUID"' failed
#
# -- output does not contain substring --
# substring : SETUID
# output    : CAP_CHOWN
# --
#
not ok 133 icap-hardening: ICAP has SETGID capability
# (from function `__assert_stream' in file tests/bats/bats-assert/src/assert_output.bash, line 236,
#  from function `assert_output' in file tests/bats/bats-assert/src/assert_output.bash, line 125,
#  in test file services/sentinel/tests/integration/icap-hardening.bats, line 232)
#   `assert_output --partial "SETGID"' failed
#
# -- output does not contain substring --
# substring : SETGID
# output    : CAP_CHOWN
# --
#
ok 134 icap-hardening: ICAP drops all other capabilities
ok 135 icap-hardening: ClamAV has no-new-privileges
ok 136 icap-hardening: ClamAV is read-only
ok 137 icap-hardening: ICAP logs to /var/log/c-icap
ok 138 icap-hardening: ICAP access log in /var/log/c-icap
ok 139 icap-hardening: ICAP log rotation configured
ok 140 icap-hardening: ICAP log file count is 3
ok 141 icap-hardening: ClamAV log rotation configured
ok 142 icap-hardening: ICAP mounts clamav-db read-only
ok 143 icap-hardening: ClamAV mounts clamav-db read-write
ok 144 icap-hardening: clamav-db volume exists
ok 145 icap-hardening: ICAP process is running as c-icap user
ok 146 icap-hardening: ICAP can write to /var/log/c-icap
ok 147 icap-hardening: ICAP can write to /var/run/c-icap
ok 148 icap-hardening: ICAP server log exists
ok 149 icap-hardening: ICAP access log exists
ok 150 icap-hardening: squidclamav service loaded
not ok 151 icap-hardening: ClamAV database files exist
# (from function `__assert_stream' in file tests/bats/bats-assert/src/assert_output.bash, line 236,
#  from function `assert_output' in file tests/bats/bats-assert/src/assert_output.bash, line 125,
#  in test file services/sentinel/tests/integration/icap-hardening.bats, line 352)
#   `assert_output --partial "daily.cvd"' failed
#
# -- output does not contain substring --
# substring (1 lines):
#   daily.cvd
# output (6 lines):
#   bytecode-339.cvd.sign
#   bytecode.cvd
#   daily.cld
#   freshclam.dat
#   main-63.cvd.sign
#   main.cvd
# --
#
ok 152 icap-hardening: ClamAV main.cvd is not empty
not ok 153 icap-hardening: ClamAV daily.cvd is not empty
# (from function `assert_success' in file tests/bats/bats-assert/src/assert_success.bash, line 45,
#  in test file services/sentinel/tests/integration/icap-hardening.bats, line 363)
#   `assert_success' failed
#
# -- command failed --
# status : 1
# output :
# --
#
ok 154 icap-hardening: ClamAV signatures are recent (within 7 days)
ok 155 icap-hardening: freshclam daemon is configured
ok 156 icap-hardening: no unanchored whitelist patterns (regression)
ok 157 icap-hardening: whitelist prevents suffix attack
ok 158 icap-hardening: whitelist allows subdomains of whitelisted domain
ok 159 icap-hardening: whitelist allows custom ports
ok 160 icap-hardening: ICAP memory usage is within limits # skip Memory usage test requires bc command
ok 161 icap-hardening: no Content-Type in scan mode config
ok 162 icap-hardening: scan mode is ScanAllExcept
ok 163 icap-hardening: no abort directive for images
ok 164 icap-hardening: no abort directive for video
ok 165 icap-hardening: no abort directive for audio
ok 166 icap-hardening: no abort directive for fonts
ok 167 icap-hardening: ICAP does not have CAP_SYS_ADMIN
ok 168 icap-hardening: ICAP does not have CAP_NET_ADMIN
ok 169 icap-hardening: ICAP is not privileged
ok 170 icap-hardening: ClamAV is not privileged
ok 171 resilience: icap has healthcheck configured
ok 172 resilience: icap uses json-file logging driver
ok 173 resilience: icap restart policy is unless-stopped
ok 174 security: icap is NOT running privileged
not ok 175 security: icap has minimal added capabilities
# (from function `__assert_stream' in file tests/bats/bats-assert/src/assert_output.bash, line 236,
#  from function `assert_output' in file tests/bats/bats-assert/src/assert_output.bash, line 125,
#  in test file services/sentinel/tests/integration/security.bats, line 19)
#   `assert_output --partial "SETUID"' failed
#
# -- output does not contain substring --
# substring : SETUID
# output    : [CAP_CHOWN]
# --
#
ok 176 security: icap runs as non-root user
ok 177 supply-chain: icap Dockerfile has SHA256 verification
ok 178 approval: REQMOD rewriter module exists
ok 179 approval: RESPMOD scanner module exists
ok 180 approval: configuration file exists
ok 181 approval: c-icap loads approval configuration
ok 182 approval: REQMOD service is registered
ok 183 approval: RESPMOD service is registered
ok 184 approval: g3proxy configured for REQMOD
ok 185 approval: g3proxy configured for RESPMOD
ok 186 approval: c-icap server is running
ok 187 approval: REQMOD service is active (via c-icap-client)
ok 188 approval: RESPMOD service is active (via c-icap-client)
ok 189 approval: valkey ACL prevents agent self-approval
ok 190 config: polis-init.service type is oneshot
ok 191 config: workspace init script mounted
ok 192 network: workspace only on internal-bridge
ok 193 network: workspace cannot reach icap directly
ok 194 network: workspace can resolve gateway via DNS
ok 195 network: workspace has default route
ok 196 resilience: workspace has healthcheck configured
ok 197 resilience: workspace uses json-file logging driver
ok 198 resilience: workspace restart policy is unless-stopped
ok 199 resilience: workspace init updates CA certificates
ok 200 security: workspace is NOT running privileged
ok 201 security: workspace uses sysbox runtime
ok 202 openclaw-int: workspace container is running # skip OpenClaw agent not running (use --agent=openclaw)
ok 203 openclaw-int: workspace uses sysbox runtime # skip OpenClaw agent not running (use --agent=openclaw)
ok 204 openclaw-int: openclaw.service file exists # skip OpenClaw agent not running (use --agent=openclaw)
ok 205 openclaw-int: openclaw.service is enabled # skip OpenClaw agent not running (use --agent=openclaw)
ok 206 openclaw-int: openclaw.service is active # skip OpenClaw agent not running (use --agent=openclaw)
ok 207 openclaw-int: openclaw.service is not failed # skip OpenClaw agent not running (use --agent=openclaw)
ok 208 openclaw-int: Node.js is installed # skip OpenClaw agent not running (use --agent=openclaw)
ok 209 openclaw-int: pnpm is installed # skip OpenClaw agent not running (use --agent=openclaw)
ok 210 openclaw-int: OpenClaw app directory exists # skip OpenClaw agent not running (use --agent=openclaw)
ok 211 openclaw-int: OpenClaw package.json exists # skip OpenClaw agent not running (use --agent=openclaw)
ok 212 openclaw-int: .openclaw directory exists # skip OpenClaw agent not running (use --agent=openclaw)
ok 213 openclaw-int: openclaw.json config exists # skip OpenClaw agent not running (use --agent=openclaw)
ok 214 openclaw-int: gateway-token.txt exists # skip OpenClaw agent not running (use --agent=openclaw)
ok 215 openclaw-int: token file has correct permissions (600) # skip OpenClaw agent not running (use --agent=openclaw)
ok 216 openclaw-int: token is 64 hex characters # skip OpenClaw agent not running (use --agent=openclaw)
ok 217 openclaw-int: config has gateway.auth.token set # skip OpenClaw agent not running (use --agent=openclaw)
ok 218 openclaw-int: config has sandbox mode off # skip OpenClaw agent not running (use --agent=openclaw)
ok 219 openclaw-int: config has controlUi enabled # skip OpenClaw agent not running (use --agent=openclaw)
ok 220 openclaw-int: .openclaw owned by polis user # skip OpenClaw agent not running (use --agent=openclaw)
ok 221 openclaw-int: gateway port 18789 is listening # skip OpenClaw agent not running (use --agent=openclaw)
ok 222 openclaw-int: gateway responds to health check # skip OpenClaw agent not running (use --agent=openclaw)
ok 223 openclaw-int: gateway port exposed to host # skip OpenClaw agent not running (use --agent=openclaw)
ok 224 openclaw-int: openclaw-init.sh exists # skip OpenClaw agent not running (use --agent=openclaw)
ok 225 openclaw-int: openclaw-init.sh is executable # skip OpenClaw agent not running (use --agent=openclaw)
ok 226 openclaw-int: openclaw-health.sh exists # skip OpenClaw agent not running (use --agent=openclaw)
ok 227 openclaw-int: .initialized marker exists # skip OpenClaw agent not running (use --agent=openclaw)
ok 228 openclaw-int: can reach gateway container # skip OpenClaw agent not running (use --agent=openclaw)
ok 229 openclaw-int: has default route via gateway # skip OpenClaw agent not running (use --agent=openclaw)
ok 230 openclaw-int: CA certificate is trusted # skip OpenClaw agent not running (use --agent=openclaw)
ok 231 openclaw-int: openclaw-gateway process is running # skip OpenClaw agent not running (use --agent=openclaw)
ok 232 openclaw-int: .env file created by init # skip OpenClaw agent not running (use --agent=openclaw)
ok 233 openclaw-int: .env has OPENCLAW_GATEWAY_PORT # skip OpenClaw agent not running (use --agent=openclaw)
ok 234 openclaw-int: API keys in container env are readable from /proc/1/environ # skip OpenClaw agent not running (use --agent=openclaw)
ok 235 openclaw-int: .env file contains API key from container env # skip OpenClaw agent not running (use --agent=openclaw)
ok 236 openclaw-int: auth-profiles.json exists for default agent # skip OpenClaw agent not running (use --agent=openclaw)
ok 237 openclaw-int: auth-profiles.json contains API key # skip OpenClaw agent not running (use --agent=openclaw)
ok 238 openclaw-int: auth-profiles.json has correct permissions (600) # skip OpenClaw agent not running (use --agent=openclaw)
