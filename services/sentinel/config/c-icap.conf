# C-ICAP Configuration for polis v0.2.5
# Uses SquidClamav for ClamAV malware scanning (fail-closed)

PidFile /var/run/c-icap/c-icap.pid
CommandsSocket /var/run/c-icap/c-icap.ctl
Timeout 300
StartServers 3
MaxServers 10
MinSpareThreads 10
MaxSpareThreads 20
ThreadsPerChild 20

# Debug level (0=critical, 1=warning, 3=info, 5=verbose)
DebugLevel 1

# Listen on all interfaces for gateway access (TCP)
Port 0.0.0.0:1344

# Logging
ServerLog /var/log/c-icap/server.log
AccessLog /var/log/c-icap/access.log

# Echo service (testing/passthrough for REQMOD)
Service echo srv_echo.so

# SquidClamav service for malware scanning
Service squidclamav squidclamav.so

# URL blocklist service
Service url_check srv_url_check.so

url_check.LookupTableDB blocklist domain hash:/etc/c-icap/blocklist.txt "Polis URL Blocklist"
url_check.Profile default block blocklist
url_check.Profile default pass ALL

# DLP module for credential detection (REQMOD)
Service polis_dlp /usr/local/lib/c_icap/srv_polis_dlp.so
ServiceAlias credcheck polis_dlp?allow204=on&allow206=on

# DLP configuration is loaded by the module itself at init time
# (polis_dlp.conf uses a custom format, not c-ICAP config syntax)

# Approval system modules (REQMOD rewriter + RESPMOD scanner)
Service polis_approval_rewrite /usr/local/lib/c_icap/srv_polis_approval_rewrite.so
Service polis_approval /usr/local/lib/c_icap/srv_polis_approval.so

# Service aliases for approval modules
ServiceAlias approval_rewrite polis_approval_rewrite?allow204=on&allow206=on
ServiceAlias approvalcheck polis_approval?allow204=on&allow206=on

# Merged RESPMOD module (ClamAV + OTT approval scanner)
Service polis_sentinel_resp /usr/local/lib/c_icap/srv_polis_sentinel_resp.so
ServiceAlias sentinel_respmod polis_sentinel_resp?allow204=on&allow206=on

# Approval configuration (time-gate, domain allowlist, TTLs)
# Include /etc/c-icap/polis_approval.conf