# SquidClamav Configuration for polis v0.2.5
# Fail-closed malware scanning with URL whitelisting for trusted repos

# ClamAV daemon connection (TCP for Docker networking)
clamd_ip scanner
clamd_port 3310

# Connection timeout (seconds)
timeout 3

# Maximum file size to scan. Must be <= clamd StreamMaxLength (both 200M).
# Files exceeding this from non-whitelisted sources are logged but allowed (fail-open for >200MB).
maxsize 200M

# Disable DNS lookup (performance; we don't use trustclient with hostnames)
dnslookup 0

# Log all virus detections to c-icap log
logredir 1

# Scan everything except explicit whitelist/abort exclusions
scan_mode ScanAllExcept

# ---------------------------------------------------------------------------
# URL Whitelisting — trusted package repositories (ANCHORED REGEXES)
# ---------------------------------------------------------------------------
# These repos have their own integrity controls (GPG signatures, lockfile
# hashes, content-addressable storage) that are stronger than inline AV.
# CRITICAL: Anchored patterns (^) prevent suffix attacks (e.g., deb.debian.org.evil.com)
#
# Debian/apt (GPG-signed Release files + package hashes)
whitelist ^https?://([a-z0-9-]+\.)*deb\.debian\.org(:[0-9]+)?(/|$)
whitelist ^https?://([a-z0-9-]+\.)*deb\.nodesource\.com(:[0-9]+)?(/|$)
# npm (integrity hashes verified by pnpm --frozen-lockfile)
whitelist ^https?://([a-z0-9-]+\.)*registry\.npmjs\.org(:[0-9]+)?(/|$)
whitelist ^https?://([a-z0-9-]+\.)*nodejs\.org(:[0-9]+)?(/|$)
# GitHub (TLS-verified, content-addressable git objects)
whitelist ^https?://([a-z0-9-]+\.)*github\.com(:[0-9]+)?(/|$)
whitelist ^https?://([a-z0-9-]+\.)*objects\.githubusercontent\.com(:[0-9]+)?(/|$)
# Bun runtime installer
whitelist ^https?://([a-z0-9-]+\.)*bun\.sh(:[0-9]+)?(/|$)
# Docker Hub (Layer Blobs are huge)
whitelist ^https?://([a-z0-9-]+\.)*production\.cloudflare\.docker\.com(:[0-9]+)?(/|$)
whitelist ^https?://([a-z0-9-]+\.)*registry-1\.docker\.io(:[0-9]+)?(/|$)
whitelist ^https?://([a-z0-9-]+\.)*auth\.docker\.io(:[0-9]+)?(/|$)
# Python (PyPI - Wheels/Source dists)
whitelist ^https?://([a-z0-9-]+\.)*pypi\.org(:[0-9]+)?(/|$)
whitelist ^https?://([a-z0-9-]+\.)*files\.pythonhosted\.org(:[0-9]+)?(/|$)
# Rust (Crates.io)
whitelist ^https?://([a-z0-9-]+\.)*crates\.io(:[0-9]+)?(/|$)
whitelist ^https?://([a-z0-9-]+\.)*static\.crates\.io(:[0-9]+)?(/|$)
# Go (Proxy)
whitelist ^https?://([a-z0-9-]+\.)*proxy\.golang\.org(:[0-9]+)?(/|$)
whitelist ^https?://([a-z0-9-]+\.)*sum\.golang\.org(:[0-9]+)?(/|$)

# ---------------------------------------------------------------------------
# No abort/abortcontent directives — scan ALL content types from
# non-whitelisted sources. ClamAV uses magic bytes, not extensions/MIME.
# ---------------------------------------------------------------------------

# Force-scan high-risk types even in ScanNothingExcept mode (defense-in-depth)
scan .*\.(exe|dll|msi|bat|cmd|ps1|vbs|js|jar|zip|rar|7z|tar|gz|doc|docx|xls|xlsx|ppt|pptx|pdf)$
